<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Lucky 3 Solitaire</title>
    <style>
        :root {
            --bg-green: #0a3d1d;
            --card-w: 20vw;
            --card-h: 28vw;
            --max-w: 80px;
            --max-h: 115px;
            --gold: #ffd700;
            --fixed-gap: -20vw;
            --anim-scale: 1;
        }

        body {
            font-family: 'Arial Black', sans-serif;
            background: #051d0e;
            margin: 0;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden;
            touch-action: manipulation;
        }

        #header {
            padding: 10px 10px;
            background: rgba(0, 0, 0, 0.62);
            border-bottom: 2px solid var(--gold);
        }

        .header-main {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            align-items: center;
            gap: 8px;
            min-height: 42px;
        }

        .header-stat {
            font-size: 11px;
            line-height: 1.2;
            min-width: 64px;
        }

        .header-title {
            color: var(--gold);
            letter-spacing: 1.6px;
            font-size: 1.02rem;
            font-weight: 900;
            text-align: center;
            line-height: 1;
        }

        .header-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .timer-pill {
            font-size: 13px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            padding: 7px 14px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 215, 0, 0.35);
            min-width: 84px;
            text-align: center;
        }

        .header-settings {
            font-size: 19px;
            line-height: 1;
            background: #263238;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            min-height: 42px;
            min-width: 48px;
            touch-action: manipulation;
        }

        @media (max-width: 520px) {
            #header {
                padding: 9px 8px;
            }

            .header-stat {
                font-size: 13px;
                min-width: 72px;
            }

            .header-title {
                font-size: 1.03rem;
                letter-spacing: 1px;
            }

            .timer-pill {
                font-size: 13px;
                min-width: 80px;
                padding: 7px 10px;
            }

            .header-settings {
                font-size: 20px;
                min-height: 42px;
                min-width: 42px;
                padding: 8px 10px;
            }
        }

        @media (orientation: landscape) and (max-height: 430px) {
            #header {
                padding: 6px 8px;
                gap: 6px;
            }

            .header-stat {
                font-size: 11px;
                min-width: 58px;
            }

            .header-title {
                font-size: 0.9rem;
                letter-spacing: 0.8px;
            }

            .header-controls {
                gap: 0;
            }

            .timer-pill {
                font-size: 11px;
                min-width: 70px;
                padding: 5px 9px;
            }

            .header-settings {
                font-size: 17px;
                min-height: 36px;
                min-width: 38px;
                padding: 7px 8px;
            }
        }

        #board {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 8px;
            padding: 20px 5px;
            transition: all calc(0.6s * var(--anim-scale)) cubic-bezier(0.4, 0, 0.2, 1);
        }

        .column {
            display: flex;
            flex-direction: column;
            width: var(--card-w);
            max-width: var(--max-w);
            min-height: 120px;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .card {
            width: var(--card-w);
            height: var(--card-h);
            max-width: var(--max-w);
            max-height: var(--max-h);
            background: white;
            border-radius: 6px;
            color: black;
            position: relative;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
            transition: transform calc(0.25s * var(--anim-scale)) cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex;
            flex-direction: column;
            padding: 6px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            margin-bottom: var(--fixed-gap);
        }

        @media (min-width: 450px) {
            .card {
                margin-bottom: -85px;
            }
        }

        .card:last-child {
            margin-bottom: 0;
        }

        .card.red {
            color: #d32f2f;
        }

        .card.is-fading {
            opacity: 0 !important;
            visibility: hidden;
        }

        .card.selected {
            transform: translateX(40%) rotate(3deg);
            outline: 3px solid var(--gold);
            filter: brightness(1.1);
        }

        .card.invalid-flash {
            animation: invalid-shake calc(0.36s * var(--anim-scale)) ease-in-out 2;
            outline: 3px solid #ff3b30 !important;
            box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.28), 0 0 16px rgba(255, 59, 48, 0.5);
        }

        @keyframes invalid-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            50% {
                transform: translateX(4px);
            }

            75% {
                transform: translateX(-3px);
            }
        }

        /* --- ÁâπÊïàÂ±§ --- */
        #fx-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .column-beam {
            position: absolute;
            width: 100%;
            height: 200vh;
            top: -50vh;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.8), transparent);
            box-shadow: 0 0 30px white;
            animation: beam-out calc(0.8s * var(--anim-scale)) ease-out forwards;
        }

        @keyframes beam-out {
            0% {
                scaleX(0);
                opacity: 0;
            }

            20% {
                scaleX(1.5);
                opacity: 1;
            }

            100% {
                scaleX(0);
                opacity: 0;
            }
        }

        .column-clear-text {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 1rem;
            color: #fff;
            text-shadow: 0 0 10px var(--gold);
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
            animation: text-float-up calc(1.2s * var(--anim-scale)) ease-out forwards;
        }

        @keyframes text-float-up {
            0% {
                transform: translate(-50%, 0);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -120px);
                opacity: 0;
            }
        }

        .combo-text {
            position: fixed;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.2rem;
            color: #fff;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 165, 0, 0.6);
            z-index: 10000;
            animation: combo-fancy calc(1.5s * var(--anim-scale)) cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes combo-fancy {
            0% {
                scale: 0.5;
                opacity: 0;
            }

            15% {
                scale: 1.2;
                opacity: 1;
            }

            75% {
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
        }

        .lucky-three-win {
            animation: win-glow 1s infinite alternate;
            z-index: 1000 !important;
        }

        @keyframes win-glow {
            from {
                transform: scale(1.2);
                box-shadow: 0 0 20px var(--gold);
            }

            to {
                transform: scale(1.4) rotate(10deg);
                box-shadow: 0 0 50px white, 0 0 100px var(--gold);
            }
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--gold);
            animation: p-fly calc(0.8s * var(--anim-scale)) forwards;
        }

        @keyframes p-fly {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        /* Footer */
        #footer {
            background: rgba(0, 0, 0, 0.95);
            padding: 15px 10px calc(15px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--gold);
        }

        .pile {
            width: 55px;
            height: 75px;
            border-radius: 5px;
            border: 1px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #deck-pile {
            background: #1e88e5;
            box-shadow: 3px 3px 0 #0d47a1;
            cursor: pointer;
            font-size: 26px;
        }

        #discard-pile {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--gold);
        }

        .has-cards {
            background: white !important;
            color: black;
            border: 1px solid #999 !important;
        }

        .btn-main {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px #000;
            cursor: pointer;
        }

        #btn-undo {
            background: #455a64;
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            box-shadow: 0 4px #263238;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #btn-undo svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        #btn-undo:disabled {
            opacity: 0.2;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-main:active {
            transform: translateY(2px);
            box-shadow: 0 2px #1b5e20;
        }

        .flying {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transition: all calc(0.5s * var(--anim-scale)) cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.face-down {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 45%, #1e88e5 100%);
            border: 1px solid #e3f2fd;
            color: transparent;
            overflow: hidden;
        }

        .card.face-down::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 4px;
            border: 2px solid rgba(255, 255, 255, 0.75);
            background:
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.35) 0 2px, transparent 3px),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.35) 0 2px, transparent 3px),
                repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.16) 0 6px, rgba(255, 255, 255, 0.05) 6px 12px);
        }

        .card.face-down::after {
            content: 'LUCKY 3';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.62rem;
            font-weight: 900;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.9);
        }

        .flying.mii-peek {
            animation: mii-peek-rise calc(0.28s * var(--anim-scale)) ease-out forwards, mii-peek-shake calc(0.58s * var(--anim-scale)) ease-in-out calc(0.3s * var(--anim-scale)) 2;
            filter: drop-shadow(0 0 14px rgba(255, 215, 0, 0.9));
        }

        .card.mii-land-pop {
            animation: mii-land-pop calc(0.42s * var(--anim-scale)) cubic-bezier(0.2, 0.9, 0.25, 1.2);
            transform-origin: 50% 85%;
        }

        @keyframes mii-land-pop {
            0% {
                transform: translateY(-8px) scale(1.08);
                filter: brightness(1.12);
            }

            55% {
                transform: translateY(2px) scale(0.97);
            }

            100% {
                transform: translateY(0) scale(1);
                filter: brightness(1);
            }
        }

        @keyframes mii-peek-rise {
            from {
                transform: translateY(0) scale(1);
            }

            to {
                transform: translateY(-12px) scale(1.07) rotate(-2deg);
            }
        }

        @keyframes mii-peek-shake {

            0%,
            100% {
                transform: translateY(-12px) scale(1.07) rotate(-2deg);
            }

            50% {
                transform: translateY(-9px) scale(1.11) rotate(2deg);
            }
        }

        .mii-text {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.82rem;
            font-weight: 900;
            letter-spacing: 0.5px;
            color: #fff;
            background: rgba(16, 18, 20, 0.88);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 999px;
            padding: 4px 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            animation: mii-text-pop calc(1.4s * var(--anim-scale)) ease-out forwards;
            z-index: 1003;
        }

        @keyframes mii-text-pop {
            0% {
                transform: translate(-50%, 8px) scale(0.9);
                opacity: 0;
            }

            18% {
                transform: translate(-50%, 0) scale(1.05);
                opacity: 1;
            }

            70% {
                transform: translate(-50%, -2px) scale(1.02);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -14px) scale(1);
                opacity: 0;
            }
        }

        .big-msg {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: var(--gold);
            text-align: center;
            z-index: 10001;
        }

        .win-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            padding: 20px;
        }

        .win-panel {
            width: min(420px, 92vw);
            background: linear-gradient(180deg, #123a1f, #0a2414);
            border: 2px solid var(--gold);
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
            padding: 20px 18px;
            text-align: center;
        }

        .win-title {
            margin: 0;
            color: var(--gold);
            font-size: 1.8rem;
            letter-spacing: 1px;
        }

        .win-subtitle {
            margin: 8px 0 14px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .win-stats {
            text-align: left;
            background: rgba(255, 255, 255, 0.07);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 14px;
        }

        .win-stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.14);
        }

        .win-stat-row:last-child {
            border-bottom: none;
        }

        .win-play-again {
            width: 100%;
            border: none;
            border-radius: 12px;
            background: var(--gold);
            color: #1b1b1b;
            font-weight: 900;
            font-size: 1.05rem;
            padding: 12px 14px;
            cursor: pointer;
            min-height: 46px;
        }

        .win-best {
            margin: 0 0 12px;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.95rem;
            background: rgba(255, 215, 0, 0.18);
            border: 1px solid rgba(255, 215, 0, 0.45);
            color: #fff8cc;
        }

        .win-fortune {
            margin: 0 0 12px;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.93rem;
            line-height: 1.45;
            background: rgba(129, 199, 132, 0.18);
            border: 1px solid rgba(165, 214, 167, 0.65);
            color: #e8ffe8;
        }

        .void-win-panel {
            width: min(430px, 92vw);
            background: radial-gradient(circle at top, #1f2a56 0%, #0d1433 55%, #070c21 100%);
            border: 2px solid #8ec7ff;
            border-radius: 16px;
            box-shadow: 0 20px 42px rgba(0, 0, 0, 0.6);
            padding: 20px 18px;
            text-align: center;
        }

        .void-win-title {
            margin: 0;
            color: #9dd3ff;
            font-size: 1.76rem;
            letter-spacing: 1px;
        }

        .void-win-subtitle {
            margin: 8px 0 14px;
            font-size: 0.95rem;
            line-height: 1.4;
            color: #d7ecff;
        }

        .void-win-badge {
            margin: 0 0 12px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(142, 199, 255, 0.7);
            background: rgba(142, 199, 255, 0.18);
            color: #eaf6ff;
            font-weight: 800;
        }

        .deadlock-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.78);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            padding: 20px;
        }

        .deadlock-panel {
            width: min(430px, 92vw);
            background: linear-gradient(180deg, #3a1111, #240a0a);
            border: 2px solid #ff6b6b;
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
            padding: 18px;
            text-align: center;
        }

        .deadlock-title {
            margin: 0;
            color: #ffd2d2;
            font-size: 1.35rem;
            letter-spacing: 0.5px;
        }

        .deadlock-text {
            margin: 10px 0 14px;
            font-size: 0.96rem;
            line-height: 1.5;
            color: #ffe6e6;
        }

        .deadlock-actions {
            display: flex;
            gap: 10px;
        }

        .deadlock-btn {
            flex: 1;
            border: none;
            border-radius: 10px;
            min-height: 44px;
            font-weight: 800;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .deadlock-btn.undo {
            background: #78909c;
            color: #102027;
        }

        .deadlock-btn.new {
            background: #ffd54f;
            color: #3e2723;
        }

        .deadlock-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .need-three-tip {
            position: fixed;
            left: 50%;
            bottom: calc(96px + env(safe-area-inset-bottom));
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9);
            color: #fff9d0;
            border: 1px solid rgba(255, 215, 0, 0.55);
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: 800;
            z-index: 10004;
            animation: need-three-fade calc(1s * var(--anim-scale)) ease-out forwards;
            pointer-events: none;
        }

        .need-three-tip.rule-hint {
            max-width: min(360px, calc(100vw - 24px));
            white-space: pre-line;
            text-align: left;
            line-height: 1.45;
            border-color: rgba(255, 183, 77, 0.9);
            color: #fff6dd;
        }

        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            z-index: 10005;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .settings-overlay.show {
            display: flex;
        }

        .settings-panel {
            width: min(430px, 92vw);
            background: linear-gradient(180deg, #143021, #0d2217);
            border: 2px solid var(--gold);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 14px 36px rgba(0, 0, 0, 0.55);
        }

        .settings-title {
            margin: 0 0 12px;
            font-size: 1.2rem;
            color: var(--gold);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-row:last-of-type {
            border-bottom: none;
        }

        .setting-label {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .setting-control {
            font-size: 0.92rem;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .setting-check {
            width: 20px;
            height: 20px;
            accent-color: #ffd54f;
        }

        .settings-close {
            margin-top: 14px;
            width: 100%;
            min-height: 44px;
            border: none;
            border-radius: 10px;
            background: #ffd54f;
            color: #1b1b1b;
            font-weight: 900;
            cursor: pointer;
        }

        .settings-achievement {
            margin-top: 10px;
            width: 100%;
            min-height: 42px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            font-weight: 800;
            cursor: pointer;
        }

        .settings-restart {
            margin-top: 10px;
            width: 100%;
            min-height: 44px;
            border: none;
            border-radius: 10px;
            background: #c62828;
            color: #fff;
            font-weight: 900;
            cursor: pointer;
        }

        .settings-secondary {
            margin-top: 10px;
            width: 100%;
            min-height: 42px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            font-weight: 800;
            cursor: pointer;
        }

        .restart-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            z-index: 10006;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .restart-overlay.show {
            display: flex;
        }

        .restart-panel {
            width: min(390px, 90vw);
            background: linear-gradient(180deg, #2e1111, #1c0909);
            border: 2px solid #ff6b6b;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 14px 36px rgba(0, 0, 0, 0.55);
            text-align: center;
        }

        .restart-title {
            margin: 0;
            color: #ffd4d4;
            font-size: 1.12rem;
        }

        .restart-text {
            margin: 10px 0 14px;
            color: #ffeaea;
            font-size: 0.94rem;
            line-height: 1.45;
        }

        .restart-actions {
            display: flex;
            gap: 10px;
        }

        .restart-btn {
            flex: 1;
            min-height: 42px;
            border: none;
            border-radius: 10px;
            font-weight: 900;
            cursor: pointer;
        }

        .restart-btn.cancel {
            background: #607d8b;
            color: #fff;
        }

        .restart-btn.confirm {
            background: #d32f2f;
            color: #fff;
        }

        .tutorial-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(440px, calc(100vw - 22px));
            z-index: 10007;
            display: none;
            pointer-events: none;
        }

        .tutorial-overlay.show {
            display: block;
        }

        .tutorial-panel {
            pointer-events: auto;
            background: linear-gradient(180deg, rgba(12, 35, 25, 0.96), rgba(7, 21, 15, 0.97));
            border: 2px solid var(--gold);
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
            padding: 12px;
        }

        .tutorial-title {
            margin: 0;
            font-size: 1.02rem;
            color: #ffe066;
            letter-spacing: 0.3px;
        }

        .tutorial-body {
            margin: 8px 0 10px;
            font-size: 0.92rem;
            line-height: 1.45;
            color: #f6fff8;
        }

        .tutorial-status {
            margin: 0 0 10px;
            font-size: 0.85rem;
            color: #d8f5de;
            opacity: 0.92;
        }

        .tutorial-actions {
            display: flex;
            gap: 8px;
        }

        .tutorial-btn {
            flex: 1;
            min-height: 38px;
            border: none;
            border-radius: 9px;
            font-weight: 800;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .tutorial-btn.primary {
            background: #ffd54f;
            color: #1f1f1f;
        }

        .tutorial-btn.secondary {
            background: #546e7a;
            color: #fff;
        }

        .achievement-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.78);
            z-index: 10008;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .achievement-overlay.show {
            display: flex;
        }

        .achievement-panel {
            width: min(440px, 92vw);
            max-height: 78vh;
            overflow: auto;
            background: linear-gradient(180deg, #112c1d, #0a1f14);
            border: 2px solid #fdd835;
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 14px 36px rgba(0, 0, 0, 0.55);
        }

        .achievement-title {
            margin: 0 0 10px;
            color: #ffe066;
            font-size: 1.2rem;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .achievement-stat {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 8px;
        }

        .achievement-stat-label {
            font-size: 0.78rem;
            opacity: 0.9;
        }

        .achievement-stat-value {
            margin-top: 2px;
            font-size: 1.05rem;
            font-weight: 900;
        }

        .achievement-badges {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .achievement-badge {
            border-radius: 10px;
            padding: 9px 10px;
            border: 1px dashed rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.06);
            font-size: 0.88rem;
        }

        .achievement-badge.unlocked {
            border-style: solid;
            border-color: rgba(255, 215, 64, 0.8);
            background: rgba(255, 215, 64, 0.18);
            color: #fff6c2;
        }

        .achievement-close {
            width: 100%;
            min-height: 42px;
            border: none;
            border-radius: 10px;
            background: #ffd54f;
            color: #1b1b1b;
            font-weight: 900;
            cursor: pointer;
        }

        body.high-contrast {
            background: #021409;
            color: #fff;
        }

        body.high-contrast .column {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.28);
        }

        body.high-contrast .card {
            border-width: 2px;
            border-color: #111;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.65);
        }

        body.high-contrast .card.selected {
            outline-color: #ffec3d;
            filter: brightness(1.14);
        }

        @keyframes need-three-fade {
            0% {
                transform: translate(-50%, 10px);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, 0);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -10px);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <div id="header">
        <div class="header-main">
            <div class="header-stat">DECK: <b id="deck-num">40</b></div>
            <div class="header-title">LUCKY 3</div>
            <div id="timer" class="timer-pill">00:00</div>
            <div class="header-controls">
                <button type="button" class="header-settings" onclick="toggleSettings(true)" aria-label="Ë®≠ÂÆö">‚öô</button>
            </div>
        </div>
    </div>

    <div id="settings-overlay" class="settings-overlay" onclick="onSettingsOverlayClick(event)">
        <div class="settings-panel">
            <h3 class="settings-title">ÈÅäÊà≤Ë®≠ÂÆö</h3>
            <div class="setting-row">
                <div class="setting-label">Èü≥Êïà</div>
                <input id="setting-sound" class="setting-check" type="checkbox">
            </div>
            <div class="setting-row">
                <div class="setting-label">ÈúáÂãï</div>
                <input id="setting-vibration" class="setting-check" type="checkbox">
            </div>
            <div class="setting-row">
                <div class="setting-label">ÂãïÁï´ÈÄüÂ∫¶</div>
                <select id="setting-animation-speed" class="setting-control">
                    <option value="slow">ÊÖ¢</option>
                    <option value="normal">‰∏≠</option>
                    <option value="fast">Âø´</option>
                </select>
            </div>
            <div class="setting-row">
                <div class="setting-label">È´òÂ∞çÊØîÊ®°Âºè</div>
                <input id="setting-high-contrast" class="setting-check" type="checkbox">
            </div>
            <button type="button" class="settings-achievement" onclick="openAchievementsFromSettings()">ÊàêÂ∞±È†ÅÈù¢</button>
            <button type="button" class="settings-secondary" onclick="replayTutorial()">ÈáçÊí≠ÊïôÂ≠∏</button>
            <button type="button" class="settings-restart" onclick="resetGameFromSettings()">ÈáçÊñ∞ÈñãÂ±Ä</button>
            <button type="button" class="settings-close" onclick="toggleSettings(false)">ÈóúÈñâË®≠ÂÆö</button>
        </div>
    </div>

    <div id="restart-overlay" class="restart-overlay" onclick="onRestartOverlayClick(event)">
        <div class="restart-panel">
            <h3 class="restart-title">Á¢∫ÂÆöÈáçÊñ∞ÈñãÂ±ÄÔºü</h3>
            <p class="restart-text">ÁõÆÂâçÁâåÂ±ÄÈÄ≤Â∫¶ÊúÉË¢´Ê∏ÖÁ©∫ÔºåÊòØÂê¶Ë¶ÅÈñãÂßãÊñ∞ÁöÑ‰∏ÄÂ±ÄÔºü</p>
            <div class="restart-actions">
                <button type="button" class="restart-btn cancel" onclick="closeRestartConfirm()">ÂèñÊ∂à</button>
                <button type="button" class="restart-btn confirm" onclick="confirmRestartGame()">ÈáçÊñ∞ÈñãÂ±Ä</button>
            </div>
        </div>
    </div>

    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-panel">
            <h3 id="tutorial-title" class="tutorial-title"></h3>
            <p id="tutorial-body" class="tutorial-body"></p>
            <p id="tutorial-status" class="tutorial-status"></p>
            <div class="tutorial-actions">
                <button id="tutorial-primary" type="button" class="tutorial-btn primary"></button>
                <button id="tutorial-secondary" type="button" class="tutorial-btn secondary"></button>
            </div>
        </div>
    </div>

    <div id="achievement-overlay" class="achievement-overlay" onclick="onAchievementOverlayClick(event)">
        <div class="achievement-panel">
            <h3 class="achievement-title">ÊàêÂ∞±È†ÅÈù¢</h3>
            <div id="achievement-grid" class="achievement-grid"></div>
            <div id="achievement-badges" class="achievement-badges"></div>
            <button type="button" class="achievement-close" onclick="closeAchievements()">ÈóúÈñâ</button>
        </div>
    </div>

    <div id="board"></div>
    <div id="fx-layer"></div>

    <div id="footer">
        <!-- ÁôºÁâå -->
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div class="pile" id="deck-pile" onclick="dealOneCard()">üÇ†</div>
            <div style="font-size: 10px; color: var(--gold); margin-top: 5px;">DEAL</div>
        </div>

        <!-- ‰∏≠ÈñìÊåâÈàï -->
        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="btn-undo" class="btn-main" onclick="undo()" disabled aria-label="Undo">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12.5 8c-2.65 0-5.05 1-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" />
                </svg>
            </button>
            <button id="btn-clear" class="btn-main" onclick="attemptClear()">Ê∂à‰∏âÂºµ / MATCH 3</button>
        </div>

        <!-- ÂõûÊî∂ -->
        <div style="text-align: center;">
            <div class="pile" id="discard-pile"></div>
            <div style="font-size: 10px; color: var(--gold); margin-top: 5px;">RECYCLE</div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });

            navigator.serviceWorker.register('./sw.js').then((registration) => {
                const activateWaiting = () => {
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                };

                activateWaiting();

                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    if (!newWorker) return;

                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            activateWaiting();
                        }
                    });
                });

                setInterval(() => {
                    registration.update().catch(() => { });
                }, 60 * 1000);

                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        registration.update().catch(() => { });
                    }
                });
            }).catch(() => { });
        }

        const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'], ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
        const GAME_STATE_KEY = 'lucky3-current-game';
        const SETTINGS_KEY = 'lucky3-settings';
        const TUTORIAL_STATE_KEY = 'lucky3-tutorial-state-v1';
        const ACHIEVEMENTS_KEY = 'lucky3-achievements-v1';
        const FORTUNE_POOL = {
            '‚ô†': [
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÂÅöÊ±∫ÂÆöÊúÉÁâπÂà•ÊûúÊñ∑ÔºåÂ∑•‰ΩúËàáÂ≠∏ÁøíÂÆπÊòì‰∏ÄÊ¨°Âà∞‰Ωç„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰Ω†‰ªäÂ§©ÁöÑË°åÂãïÂäõÂæàÂº∑ÔºåÂç°ÈóúÁöÑ‰∫ãÊúâÊ©üÊúÉÂø´ÈÄüÁ™ÅÁ†¥„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰ªäÂ§©ÂæàÈÅ©ÂêàËôïÁêÜÊúÄÈõ£ÁöÑÈÇ£‰ª∂‰∫ãÔºåÂÆåÊàêÁéáÂÅèÈ´ò„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÂ∞àÊ≥®Âäõ‰∏äÂçáÔºåÁü≠ÊôÇÈñìÂÖßÂ∞±ËÉΩÊääÈáçÈªûÂÅöÂÆå„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰Ω†‰ªäÂ§©ÁöÑÂà§Êñ∑ÂæàÊ∫ñÔºåÈÅ©ÂêàÊãçÊùøÂÆöÊ°à„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÂãáÊï¢ÂæÄÂâç‰∏ÄÊ≠•ÔºåÊúÉÈÅáÂà∞ÈóúÈçµËΩâÊ©ü„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÊïàÁéáÈÅã‰∫ÆËµ∑‰æÜÔºå‰ªäÂ§©ÂÅö‰∫ãÊúÉÁâπÂà•‰øêËêΩ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàÊ∏ÖÂñÆÂºèÊé®ÈÄ≤ÔºåË∂äÂÅöË∂äÈ†Ü„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÊÄùË∑ØÊ∏ÖÊô∞ÔºåË§áÈõúÂïèÈ°åÊúÉË¢´‰Ω†ÊãÜÂæóÂæàÊºÇ‰∫Æ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰ªäÂ§©ÊòØÁ™ÅÁ†¥Êó•ÔºåÂÖàÂÅöÊúÄÈõ£ÁöÑÂèçËÄåÊúÄÁúÅÂäõ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰Ω†ÊúÉÊØîÈ†êÊúüÊõ¥Âø´ÁúãÂà∞ÊàêÊûúÔºåÊîæÂøÉË°ùÂà∫„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÈÅ©ÂêàÈñãÂïüÊñ∞Ë®àÁï´ÔºåÁ¨¨‰∏ÄÊ≠•Â∞±ÊúâÂ•ΩÊâãÊÑü„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇËá®Â†¥ÂèçÊáâÁâπÂà•Â•ΩÔºå‰ªäÂ§©ÂæàÊúâ‰∏ªÂ∞éÊ¨ä„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰ªäÂ§©ÂÅöÂèñÊç®ÁâπÂà•Ê∫ñÔºåÊôÇÈñìÊúÉË¢´‰Ω†Áî®ÂæóÂæàÂ•Ω„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇ‰Ω†‰ªäÂ§©ÁöÑÁØÄÂ•èÂæàÁ©©ÔºåÂÆπÊòìÈÄ£Á∫åÊãø‰∏ãÂ∞èÂãùÂà©„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÈªëÊ°É 3„ÄÇÁõ¥Ë¶∫ËàáÁêÜÊÄßÂêåÊôÇÂú®Á∑öÔºåÂÅö‰ªÄÈ∫ºÈÉΩÊõ¥ÊúâÊääÊè°„ÄÇ'
            ],
            '‚ô•': [
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰∫∫ÈöõÈÅã‰∏äÂçáÔºåÈÅ©Âêà‰∏ªÂãïËÅØÁµ°ÈáçË¶ÅÁöÑ‰∫∫ÔºåÊúÉÊúâÂ•ΩÂõûÊáâ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰ªäÂ§©ÁâπÂà•ÊúâÊ∫´ÊöñÁ∑£ÂàÜÔºåÂêà‰ΩúËàáÊ∫ùÈÄöÈÉΩÊõ¥È†Ü„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰ªäÂ§©Ë™™Âá∫ÁöÑÂñÑÊÑèÊúÉË¢´ÊîæÂ§ßÔºåÂõûÈ•ãÊúÉÂæàÂø´Âá∫Áèæ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÈóú‰øÇÈÅãËµ∞Âº∑ÔºåÈÅ©Âêà‰øÆÂæ©Â∞èË™§ÊúÉ„ÄÅÊãâËøëË∑ùÈõ¢„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰Ω†‰ªäÂ§©ÂæàÊúâÊÑüÊüìÂäõÔºåÂÆπÊòìÂæóÂà∞ÊîØÊåÅ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàË°®ÈÅîÊÑüË¨ùÔºåÊúÉÊî∂Á©´Ë∂Ö‰πéÈ†êÊúüÁöÑÂñÑÊÑè„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÊÉÖÁ∑íÈüåÊÄßÈ´òÔºå‰ªäÂ§©ËÉΩÊääÂøÉÊÉÖÁÖßÈ°ßÂæóÂæàÂ•Ω„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÊ∫ùÈÄöÈÅã‰Ω≥ÔºåÈõ£ËÅäÁöÑË©±È°å‰πüËÉΩÊüîÈ†ÜËêΩÂú∞„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰ªäÂ§©ÂÆπÊòìÈÅáÂà∞È°òÊÑèÂπ´‰Ω†‰∏ÄÊääÁöÑ‰∫∫„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÁúüË™†ÊúÉÊàêÁÇ∫‰Ω†ÁöÑÂπ∏ÈÅãÈë∞Âåô„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàÂêà‰ΩúÔºåÂΩºÊ≠§Âä†ÊàêÊÑüÁâπÂà•ÊòéÈ°Ø„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÊääÂøÉË£°ÊÉ≥Ë™™ÁöÑË™™Âá∫Âè£ÔºåÊúÉÊúâÊ∫´ÊöñÂõûÈü≥„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰ªäÂ§©ÁöÑ‰Ω†ÂæàÊúâË¶™ÂíåÂäõÔºåÈóú‰øÇËá™ÁÑ∂ÂçáÊ∫´„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÊüîËªü‰ΩÜ‰∏çÈÄÄËÆìÔºå‰ªäÂ§©ÊúÉÊòØÂæàÊºÇ‰∫ÆÁöÑÂπ≥Ë°°„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇ‰Ω†‰ªäÂ§©Êï£ÁôºÂÆâÂÆöÊÑüÔºåÂÆπÊòìÊàêÁÇ∫ÂúòÈöäÊ†∏ÂøÉ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÁ¥ÖÂøÉ 3„ÄÇÈñãÊîæÂøÉÊÖãÊúÉÂ∏∂‰æÜ‰∏ÄÂÄãËÆì‰Ω†ÂøÉÊÉÖÂæàÂ•ΩÁöÑÊ∂àÊÅØ„ÄÇ'
            ],
            '‚ô¶': [
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇË≤°ÈÅãËàáÊ©üÊúÉÈÅãÂÅèÂº∑ÔºåÂ∞èÊ©üÊúÉÂèØËÉΩÂ∏∂‰æÜÂ§ßÊî∂Á©´„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàË´áË≥áÊ∫êËàáÊïàÁéáÔºåÂÆπÊòìÊãøÂà∞Ë∂ÖÂÄºÁµêÊûú„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰ªäÂ§©Â∞çÂÉπÊ†ºËàáÂÉπÂÄºÁöÑÂà§Êñ∑ÁâπÂà•Ê∫ñ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇÂ∞èÂ∞èÂòóË©¶ÊúÉÂ∏∂‰æÜÂØ¶ÈöõÂõûÂ†±ÔºåÂÄºÂæó‰∏ªÂãïÂá∫Êìä„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàÊï¥ÁêÜË≤°ÂãôËàáË®àÁï´ÔºåÊúÉË∂äÁêÜË∂äÊ∏ÖÊ•ö„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰Ω†‰ªäÂ§©ÂæàÂÆπÊòìÊäìÂà∞È´ò CP ÁöÑÈÅ∏Êìá„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇÂØ¶Áî®ÈÅãÂæàÂº∑ÔºåÊâãÈÇäÂ∑•ÂÖ∑ËàáË≥áÊ∫êÈÉΩËÉΩÊ¥æ‰∏äÁî®Â†¥„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰ªäÂ§©ÊòØ„ÄåÂ∞èÊäïÂÖ•Â§ßÂõûÂ†±„ÄçÁöÑ‰∏ÄÂ§©„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰Ω†‰ªäÂ§©ÊúÉÈÅáÂà∞ÊèêÂçáÊïàÁéáÁöÑÈóúÈçµÁ∑öÁ¥¢„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇÈÅ©ÂêàÊääÊÉ≥Ê≥ïËêΩÂú∞ÔºåÊàêÊûúÊúÉÊØîÈ†êÊúüÂø´„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰ªäÂ§©ÁöÑÈÅ∏ÊìáÈ°åÔºå‰Ω†Êõ¥ÂÆπÊòìÈÅ∏Âà∞Â∞çÁöÑÈÇ£ÂÄã„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇÊääÊè°Â∞èÁ™óÂè£ÔºåÂèØËÉΩÊèõ‰æÜÈï∑ÊúüÂ•ΩËôï„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàË´áÊ¢ù‰ª∂Ôºå‰Ω†ÊúÉÊãøÂà∞ÊºÇ‰∫ÆÂπ≥Ë°°Èªû„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇÂÅèË≤°ÊòØË≥áË®äÈÅãÔºå‰ªäÂ§©Â§öÁúã‰∏ÄÁúºÂ∞±ÊúâÊî∂Á©´„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇ‰Ω†‰ªäÂ§©ÁöÑÂãôÂØ¶ÂäõÂæàÂº∑ÔºåÊàêÊïàÁúãÂæóË¶ã„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊñπÂ°ä 3„ÄÇÂ•ΩÊ©üÊúÉÊ≠£Âú®Èù†ËøëÔºåË®òÂæó‰∏ªÂãï‰º∏ÊâãÊé•‰Ωè„ÄÇ'
            ],
            '‚ô£': [
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇÁ©©ÂÆöÈÅãÂæàÂº∑ÔºåÊâã‰∏äÁöÑË®àÁï´ÂèØÊúõÊâéÂØ¶Êé®ÈÄ≤„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàÊâìÂü∫Á§éÔºåÊåÅÁ∫åÂÅöÂ∞±ÊúÉÁúãÂà∞ÊòéÈ°ØÊàêÊûú„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇÁ¥ØÁ©çÂûã‰ªªÂãô‰ªäÂ§©ÁâπÂà•ÊúâÊÑüÔºåË∂äÂÅöË∂äÈ†Ü„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰Ω†ÁöÑËÄêÂøÉ‰ªäÂ§©Â∞±ÊòØÂπ∏ÈÅãÔºåÊÖ¢ÊÖ¢‰æÜÂèçËÄåÊúÄÂø´„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰ªäÂ§©ÈÅ©ÂêàÊääÊµÅÁ®ãÂÑ™ÂåñÔºåÂæåÁ∫åÊúÉÁúÅÂæàÂ§öÂäõ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇÁ©©Á©©ÂâçÈÄ≤Â∞±ÊòØÁéãÈÅìÔºåÊàêÊûúÊ≠£Âú®Â†ÜÈ´ò„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰ªäÂ§©ÊòØ„ÄåÂ∞èÊ≠•Âø´Ë∑ë„ÄçÁöÑÂ•ΩÊó•Â≠ê„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰Ω†‰ªäÂ§©ÂæàÈÅ©ÂêàÊî∂ÊñÇËàáÊï¥ÁêÜÔºåÂìÅË≥™ÊúÉ‰∏äÂçá„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇÊääÁØÄÂ•èÂÆà‰ΩèÔºå‰ªäÂ§©ÊúÉÊî∂Á©´‰∏ÄÁ®ÆË∏èÂØ¶ÁöÑÂ•ΩÈÅã„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇÁ©©ÂÆöÊé®ÈÄ≤Â∏∂‰æÜÈ©öÂñúÔºåÊôö‰∏ÄÈªûÊúÉÁúãÂà∞ÂõûÂ†±„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰ªäÂ§©ÂæàÈÅ©ÂêàÂÆåÊàê„ÄåÂ∑ÆÊúÄÂæå‰∏ÄÊ≠•„ÄçÁöÑ‰ªªÂãô„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰Ω†‰ªäÂ§©ÁöÑÊåÅÁ∫åÂäõÂæàÂº∑ÔºåÈÅ©ÂêàÂÅöÈï∑Á∑öÂ∏ÉÂ±Ä„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰ªäÂ§©ÊääÂü∫Á§éÊâìÂ•ΩÔºåÊòéÂ§©Â∞±ËÉΩÂä†ÈÄüËµ∑È£õ„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰Ω†ÁöÑÁØÄÂ•èÊÑüÂú®Á∑öÔºå‰∫ãÊÉÖÊúÉ‰∏Ä‰ª∂‰ª∂Âà∞‰Ωç„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰øùÊåÅÁ∞°ÂñÆËàá‰∏ÄËá¥Ôºå‰ªäÂ§©ÊúÉÈùûÂ∏∏ÊúâÊî∂Á©´„ÄÇ',
                '‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöÊ¢ÖËä± 3„ÄÇ‰ªäÂ§©ÊòØÊàêÈï∑Êó•ÔºåÁ©©ÂÆöÂ∞±ÊòØÊúÄÂº∑Âπ∏ÈÅã„ÄÇ'
            ]
        };
        const CURATED_SEED_POOL = [4, 13, 17, 20, 23, 25, 27, 28, 36, 47, 49, 59, 60, 73, 74, 85, 109, 111, 112, 124, 125, 134, 135, 142, 144, 146, 166, 169, 180, 195, 200, 201, 213, 219, 225, 229, 230, 243, 250, 265, 268, 273, 276, 294, 304, 305, 313, 314, 316, 320, 323, 325, 328, 330, 342, 345, 355, 356, 368, 372, 376, 380, 381, 383, 384, 412, 413, 423, 425, 430, 433, 435, 438, 443, 452, 453, 456, 465, 467, 468, 470, 471, 475, 492, 495, 500, 505, 507, 509, 526, 531, 533, 534, 537, 539, 541, 542, 554, 556, 587, 608, 611, 619, 627, 630, 636, 638, 660, 662, 668, 676, 681, 686, 691, 697, 698, 699, 709, 710, 715, 716, 719, 723, 724, 725, 737, 739, 740, 742, 744, 745, 748, 752, 755, 769, 773, 776, 781, 788, 790, 797, 801, 804, 811, 812, 827, 834, 837, 856, 858, 863, 865, 866, 869, 871, 874, 882, 884, 899, 902, 905, 911, 914, 915, 920, 933, 949, 969, 978, 987, 990, 992, 997, 1004, 1011, 1015, 1017, 1022, 1024, 1026, 1030, 1031, 1043, 1046, 1055, 1058, 1059, 1062, 1070, 1072, 1075, 1083, 1084, 1088, 1089, 1091, 1099, 1102, 1105, 1106, 1107, 1110, 1111, 1113, 1114, 1115, 1120, 1122, 1123, 1132, 1133, 1135, 1137, 1139, 1140, 1142, 1145, 1146, 1148, 1153, 1156, 1157, 1159, 1172, 1176, 1178, 1183, 1193, 1198, 1207, 1209, 1219, 1223, 1227, 1229, 1244, 1247, 1256, 1261, 1271, 1276, 1277, 1281, 1294, 1295, 1297, 1302, 1309, 1315, 1319, 1333, 1334, 1337, 1339, 1344, 1349, 1350, 1352, 1353, 1357, 1363, 1365, 1366, 1370, 1375, 1385, 1389, 1390, 1396, 1397, 1401, 1402, 1405, 1409, 1417, 1422, 1423, 1431, 1443, 1448, 1451, 1464, 1468, 1469, 1475, 1476, 1487, 1491, 1493, 1494, 1502, 1530, 1532, 1535, 1537, 1541, 1543, 1560, 1564, 1565, 1571, 1575, 1576, 1579, 1583, 1587, 1598, 1603, 1604, 1605, 1612, 1615, 1630, 1643, 1647, 1652, 1659, 1666, 1669, 1678, 1679, 1680, 1687, 1688, 1694, 1696, 1697, 1703, 1722, 1726, 1733, 1746, 1749, 1753, 1759, 1761, 1765, 1768, 1771, 1777, 1781, 1784, 1791, 1793, 1794, 1796, 1812, 1815, 1820, 1825, 1831, 1836, 1839, 1847, 1851, 1862, 1867, 1868, 1877, 1878, 1881, 1883, 1885, 1892, 1893, 1897, 1901, 1903, 1905, 1908, 1909, 1913, 1916, 1917, 1924, 1928, 1929, 1930, 1933, 1941, 1942, 1944, 1950, 1954, 1958, 1960, 1979, 1980, 1982, 1995, 2001, 2007, 2009, 2015, 2027, 2030, 2031, 2034, 2047, 2050, 2052, 2053, 2055, 2070, 2076, 2077, 2083, 2084, 2089, 2092, 2093, 2095, 2097, 2103, 2107, 2108, 2110, 2112, 2120, 2125, 2130, 2136, 2137, 2139, 2146, 2148, 2155, 2158, 2163, 2173, 2182, 2186, 2200, 2206, 2207, 2211, 2217, 2218, 2223, 2224, 2227, 2234, 2237, 2252, 2254, 2257, 2269, 2279, 2288, 2289, 2293, 2306, 2310, 2311, 2322, 2323, 2329, 2331, 2332, 2337, 2342, 2361, 2371, 2375, 2376, 2380, 2384, 2392, 2397, 2398, 2399, 2401, 2406, 2407, 2414, 2416, 2418, 2419, 2420, 2423, 2425, 2430, 2431, 2445, 2460, 2461, 2467, 2469, 2473, 2476, 2479, 2483, 2484, 2486, 2499, 11, 16, 29, 50, 62];
        const DEFAULT_SETTINGS = { sound: true, vibration: true, animationSpeed: 'normal', highContrast: false };
        const DEFAULT_ACHIEVEMENTS = {
            wins: 0,
            zeroClearWins: 0,
            maxCombo: 0,
            bestMoves: null,
            bestTimeSec: null,
            currentStreak: 0,
            longestStreak: 0,
            lastWinDate: ''
        };
        let deck = [], slots = [], discardPile = [], clearedGroups = [];
        let selected = [], nextSlotIndex = 0, isBusy = false, historyStack = [], combo = 0, lastCleared = null, startTime = Date.now();
        let winInterval = null, moveCount = 0, maxCombo = 0, hasWon = false, deadlockShown = false;
        let settings = { ...DEFAULT_SETTINGS };
        let achievements = { ...DEFAULT_ACHIEVEMENTS };
        let audioCtx = null;
        let tutorial = { active: false, step: 0 };
        let tutorialDeckMode = false;
        let winCardSuit = '';

        function shuffleInPlace(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function mulberry32(seed) {
            let t = seed >>> 0;
            return function () {
                t += 0x6D2B79F5;
                let x = Math.imul(t ^ (t >>> 15), 1 | t);
                x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
                return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
            };
        }

        function shuffleWithRng(arr, rng) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function pickCuratedSeed() {
            if (!Array.isArray(CURATED_SEED_POOL) || CURATED_SEED_POOL.length === 0) return null;
            const idx = Math.floor(Math.random() * CURATED_SEED_POOL.length);
            return CURATED_SEED_POOL[idx] >>> 0;
        }

        function buildSeededDeck(seed) {
            const fullDeck = [];
            suits.forEach(s => ranks.forEach(r => {
                fullDeck.push({ rank: r, suit: s, val: r === 'A' ? 1 : parseInt(r), color: s === '‚ô•' || s === '‚ô¶' ? 'red' : 'black' });
            }));
            const rng = mulberry32(seed >>> 0);
            return shuffleWithRng(fullDeck, rng);
        }

        function createCard(rank, suit) {
            return { rank, suit, val: rank === 'A' ? 1 : parseInt(rank, 10), color: suit === '‚ô•' || suit === '‚ô¶' ? 'red' : 'black' };
        }

        function fortuneBySuit(suit) {
            const list = FORTUNE_POOL[suit] || ['‰ªäÊó•Âπ∏ÈÅãÁ±§ÔºöLucky 3„ÄÇ‰ªäÂ§©ÊúÉÊúâ‰∏Ä‰ª∂Â∞èÂ•Ω‰∫ãÊÇÑÊÇÑÁôºÁîü„ÄÇ'];
            return list[Math.floor(Math.random() * list.length)];
        }

        function cardId(rank, suit) {
            return `${rank}${suit}`;
        }

        function buildTutorialDeck() {
            const fixedBottom = createCard('3', '‚ô£');
            const openingPlan = [
                createCard('2', '‚ô†'),
                createCard('10', '‚ô¶'),
                createCard('9', '‚ô£'),
                createCard('5', '‚ô¶'),
                createCard('3', '‚ô•'),
                createCard('A', '‚ô£'),
                createCard('10', '‚ô†'),
                createCard('6', '‚ô†'),
                createCard('4', '‚ô£'),
                createCard('8', '‚ô•'),
                createCard('10', '‚ô•'),
                createCard('7', '‚ô•')
            ];

            const used = new Set(openingPlan.map((c) => cardId(c.rank, c.suit)));
            used.add(cardId(fixedBottom.rank, fixedBottom.suit));

            const remaining = [];
            suits.forEach((s) => ranks.forEach((r) => {
                const id = cardId(r, s);
                if (used.has(id)) return;
                remaining.push(createCard(r, s));
            }));
            shuffleInPlace(remaining);

            const topDeck = [...remaining, ...openingPlan.slice().reverse()];
            return [fixedBottom, ...topDeck];
        }

        function seedOpeningCards(cardsPerColumn = 3) {
            for (let round = 0; round < cardsPerColumn; round++) {
                for (let i = 0; i < slots.length; i++) {
                    if (deck.length === 0) return;
                    slots[i].cards.push(deck.pop());
                }
            }
        }

        function runOpeningDealAnimation(cardsPerColumn = 3) {
            const queue = [];
            for (let round = 0; round < cardsPerColumn; round++) {
                for (let i = 0; i < slots.length; i++) {
                    queue.push(slots[i].id);
                }
            }

            isBusy = true;
            selected = [];
            render();

            return new Promise((resolve) => {
                const step = (index) => {
                    if (index >= queue.length || deck.length === 0) {
                        isBusy = false;
                        resolve();
                        return;
                    }

                    const slotId = queue[index];
                    const slot = slots.find((s) => s.id === slotId);
                    if (!slot || !slot.active) {
                        step(index + 1);
                        return;
                    }

                    const card = deck.pop();
                    const deckRect = document.getElementById('deck-pile').getBoundingClientRect();
                    const colEl = document.getElementById(`col-${slotId}`);
                    const colRect = colEl.getBoundingClientRect();
                    const targetTop = getDealTargetTop(colEl, slot.cards.length);
                    const fly = createFly(card, deckRect);
                    const flyDuration = getDelay(360);
                    fly.style.willChange = 'transform';
                    fly.style.transform = 'translate(0, 0)';

                    playSound('deal');
                    const deltaX = colRect.left - deckRect.left;
                    const deltaY = targetTop - deckRect.top;
                    const motion = fly.animate(
                        [
                            { transform: 'translate(0, 0)' },
                            { transform: `translate(${deltaX}px, ${deltaY}px)` }
                        ],
                        {
                            duration: flyDuration,
                            easing: 'cubic-bezier(0.22, 0.61, 0.36, 1)',
                            fill: 'forwards'
                        }
                    );

                    motion.onfinish = () => {
                        slot.cards.push(card);
                        fly.remove();
                        render();
                        setTimeout(() => step(index + 1), getDelay(30));
                    };
                };

                step(0);
            });
        }

        function getAnimScale() {
            if (settings.animationSpeed === 'slow') return 1.35;
            if (settings.animationSpeed === 'fast') return 0.75;
            return 1;
        }

        function getDelay(ms) {
            return Math.max(40, Math.round(ms * getAnimScale()));
        }

        function loadSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_KEY);
                if (!raw) return { ...DEFAULT_SETTINGS };
                const parsed = JSON.parse(raw);
                return {
                    sound: parsed.sound !== false,
                    vibration: parsed.vibration !== false,
                    animationSpeed: ['slow', 'normal', 'fast'].includes(parsed.animationSpeed) ? parsed.animationSpeed : 'normal',
                    highContrast: Boolean(parsed.highContrast)
                };
            } catch (_) {
                return { ...DEFAULT_SETTINGS };
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (_) { }
        }

        function applySettings() {
            document.documentElement.style.setProperty('--anim-scale', String(getAnimScale()));
            document.body.classList.toggle('high-contrast', settings.highContrast);

            const soundEl = document.getElementById('setting-sound');
            const vibrationEl = document.getElementById('setting-vibration');
            const speedEl = document.getElementById('setting-animation-speed');
            const contrastEl = document.getElementById('setting-high-contrast');
            if (soundEl) soundEl.checked = settings.sound;
            if (vibrationEl) vibrationEl.checked = settings.vibration;
            if (speedEl) speedEl.value = settings.animationSpeed;
            if (contrastEl) contrastEl.checked = settings.highContrast;
        }

        function updateSetting(key, value) {
            settings[key] = value;
            applySettings();
            saveSettings();
        }

        function toggleSettings(show) {
            const overlay = document.getElementById('settings-overlay');
            if (!overlay) return;
            overlay.classList.toggle('show', show);
        }

        function onSettingsOverlayClick(event) {
            if (event.target && event.target.id === 'settings-overlay') {
                toggleSettings(false);
            }
        }

        function bindSettingsUI() {
            const soundEl = document.getElementById('setting-sound');
            const vibrationEl = document.getElementById('setting-vibration');
            const speedEl = document.getElementById('setting-animation-speed');
            const contrastEl = document.getElementById('setting-high-contrast');
            if (!soundEl || !vibrationEl || !speedEl || !contrastEl) return;

            soundEl.addEventListener('change', (e) => updateSetting('sound', e.target.checked));
            vibrationEl.addEventListener('change', (e) => updateSetting('vibration', e.target.checked));
            speedEl.addEventListener('change', (e) => updateSetting('animationSpeed', e.target.value));
            contrastEl.addEventListener('change', (e) => updateSetting('highContrast', e.target.checked));
        }

        function getTutorialState() {
            try {
                return localStorage.getItem(TUTORIAL_STATE_KEY) || 'unseen';
            } catch (_) {
                return 'unseen';
            }
        }

        function isTutorialDismissed() {
            const state = getTutorialState();
            return state === 'completed' || state === 'skipped';
        }

        function setTutorialState(state) {
            try {
                localStorage.setItem(TUTORIAL_STATE_KEY, state);
            } catch (_) { }
        }

        function toggleTutorial(show) {
            const overlay = document.getElementById('tutorial-overlay');
            if (!overlay) return;
            overlay.classList.toggle('show', show);
        }

        function startTutorial(force = false) {
            if (!force && isTutorialDismissed()) return;
            tutorial.active = true;
            tutorial.step = 0;
            renderTutorial();
            toggleTutorial(true);
        }

        function closeTutorial(state = null) {
            tutorial.active = false;
            if (state === 'completed' || state === 'skipped') setTutorialState(state);
            toggleTutorial(false);
        }

        function replayTutorial() {
            toggleSettings(false);
            tutorialDeckMode = true;
            init(true);
        }

        function nextTutorialStep() {
            tutorial.step = Math.min(4, tutorial.step + 1);
            if (tutorial.step === 4) {
                setTutorialState('completed');
                playSound('hint');
            }
            renderTutorial();
        }

        function renderTutorial() {
            if (!tutorial.active) return;
            const title = document.getElementById('tutorial-title');
            const body = document.getElementById('tutorial-body');
            const status = document.getElementById('tutorial-status');
            const primary = document.getElementById('tutorial-primary');
            const secondary = document.getElementById('tutorial-secondary');
            if (!title || !body || !status || !primary || !secondary) return;

            if (tutorial.step === 0) {
                title.innerText = 'Êñ∞ÊâãÊïôÂ≠∏ÔºàÁ¥Ñ 30 ÁßíÔºâ';
                body.innerText = 'ÁõÆÊ®ôÊòØÊääÁâåÂ±ÄÁé©Âà∞ÊúÄÂæåÂè™Ââ©‰∏ÄÂºµ„Äå3„Äç„ÄÇÊ∏ÖÁâåË¶èÂâáÔºöÂêå‰∏ÄÂàóÈÅ∏ 3 ÂºµÔºå‰∏îÁ∏ΩÂíåË¶ÅÊòØ 9 / 19 / 29„ÄÇ';
                status.innerText = 'Ê∫ñÂÇôÂ•ΩÂæåÈñãÂßãÔºåÊïôÂ≠∏‰∏çÊúÉÊìã‰Ωè‰Ω†Êìç‰Ωú„ÄÇ';
                primary.innerText = 'ÈñãÂßãÊïôÂ≠∏';
                secondary.innerText = 'Áï•ÈÅé';
                primary.onclick = () => { tutorial.step = 1; renderTutorial(); };
                secondary.onclick = () => closeTutorial('skipped');
                primary.style.display = '';
                secondary.style.display = '';
                return;
            }

            if (tutorial.step === 1) {
                title.innerText = 'Ê≠•È©ü 1ÔºöÂÖàÁôº‰∏ÄÂºµÁâå';
                body.innerText = 'Ë´ãÈªûÂ∫ïÈÉ®Â∑¶ÂÅ¥„ÄåDEAL„ÄçÁôº‰∏ÄÂºµÁâåÔºåÁÜüÊÇâÁØÄÂ•è„ÄÇ';
                status.innerText = 'Á≠âÂæÖ‰Ω†ÈªûÊìä DEAL...';
                primary.style.display = 'none';
                secondary.style.display = '';
                secondary.innerText = 'Áï•ÈÅéÊïôÂ≠∏';
                secondary.onclick = () => closeTutorial('skipped');
                return;
            }

            if (tutorial.step === 2) {
                title.innerText = 'Ê≠•È©ü 2ÔºöÈÅ∏Êªø‰∏âÂºµ';
                body.innerText = 'Âú®Âêå‰∏ÄÂàóÈÅ∏ 3 ÂºµÔºåÂêàÊ≥ï‰ΩçÁΩÆÂè™Êúâ‰∏âÁ®ÆÔºö‚ë† Â∞æ‰∏âÂºµÔºàÂâç‰∏âÂºµÔºâ‚ë° È†≠1Â∞æ2 ‚ë¢ È†≠2Â∞æ1„ÄÇ';
                status.innerText = 'Á≠âÂæÖ‰Ω†Áî®‰∏äËø∞ÂÖ∂‰∏≠‰∏ÄÁ®Æ‰ΩçÁΩÆÈÅ∏Êªø 3 Âºµ...';
                primary.style.display = 'none';
                secondary.style.display = '';
                secondary.innerText = 'Áï•ÈÅéÊïôÂ≠∏';
                secondary.onclick = () => closeTutorial('skipped');
                return;
            }

            if (tutorial.step === 3) {
                title.innerText = 'Ê≠•È©ü 3ÔºöÂòóË©¶Ê∂à‰∏âÂºµ';
                body.innerText = 'Êåâ‰∏ã„ÄåÊ∂à‰∏âÂºµ / MATCH 3„Äç„ÄÇÂè™Ë¶ÅÁ∏ΩÂíåÊòØ 9 / 19 / 29Ôºå‰∏î‰ΩçÁΩÆÁ¨¶Âêà„ÄåÂ∞æ‰∏âÂºµ / È†≠1Â∞æ2 / È†≠2Â∞æ1„ÄçÂ∞±ËÉΩÊ∂àÈô§„ÄÇ';
                status.innerText = 'Á≠âÂæÖ‰Ω†Êåâ‰∏ã MATCH 3...';
                primary.style.display = 'none';
                secondary.style.display = '';
                secondary.innerText = 'Áï•ÈÅéÊïôÂ≠∏';
                secondary.onclick = () => closeTutorial('skipped');
                return;
            }

            title.innerText = 'ÂÆåÊàêÔºÅ‰Ω†Â∑≤ÊúÉÂü∫Êú¨Áé©Ê≥ï';
            body.innerText = 'Êé•‰∏ã‰æÜÁõÆÊ®ôÊòØÁî®ÊúÄÂ∞ëÊ≠•Êï∏ÂÆåÊàêÁâåÂ±Ä„ÄÇ‰πãÂæåÂèØÂú®Ë®≠ÂÆö‰∏≠„ÄåÈáçÊí≠ÊïôÂ≠∏„Äç„ÄÇ';
            status.innerText = 'Á•ù‰Ω†ÈÄ£ÊìäÈ†ÜÂà©ÔºåÊãø‰∏ã Lucky 3ÔºÅ';
            primary.style.display = '';
            secondary.style.display = 'none';
            primary.innerText = 'ÂÆåÊàê';
            primary.onclick = () => closeTutorial('completed');
        }

        function onTutorialEvent(eventName) {
            if (!tutorial.active) return;
            if (tutorial.step === 1 && eventName === 'deal') {
                nextTutorialStep();
                return;
            }
            if (tutorial.step === 2 && eventName === 'selected_three') {
                nextTutorialStep();
                return;
            }
            if (tutorial.step === 3 && eventName === 'attempt_clear_success') {
                nextTutorialStep();
            }
        }

        function isLegalSelectionPosition(cardsLen, selectedIndices) {
            if (cardsLen < 3 || selectedIndices.length !== 3) return false;
            const sorted = [...selectedIndices].sort((a, b) => a - b);
            const legal =
                JSON.stringify(sorted) === JSON.stringify([cardsLen - 3, cardsLen - 2, cardsLen - 1]) ||
                JSON.stringify(sorted) === JSON.stringify([0, cardsLen - 2, cardsLen - 1]) ||
                JSON.stringify(sorted) === JSON.stringify([0, 1, cardsLen - 1]);
            return legal;
        }

        function showTutorialRuleHint() {
            const old = document.getElementById('need-three-tip');
            if (old) old.remove();
            const msg = document.createElement('div');
            msg.id = 'need-three-tip';
            msg.className = 'need-three-tip rule-hint';
            msg.innerText = 'ÊïôÂ≠∏ÊèêÁ§∫ÔºöÂøÖÈ†àÁ¨¶Âêà‰ª•‰∏ãÂÖ∂‰∏Ä\n1) Â∞æ‰∏âÂºµÔºàÂâç‰∏âÂºµÔºâ\n2) È†≠1Â∞æ2\n3) È†≠2Â∞æ1';
            document.body.appendChild(msg);
            triggerHaptic([18, 24, 18]);
            playSound('hint');
            setTimeout(() => {
                if (msg.parentNode) msg.remove();
            }, getDelay(1300));
        }

        function playTone(freq = 440, durationMs = 80, volume = 0.04, startAt = 0) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            if (!audioCtx) audioCtx = new Ctx();
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => { });

            const now = audioCtx.currentTime + startAt;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.linearRampToValueAtTime(volume, now + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + durationMs / 1000);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + durationMs / 1000 + 0.02);
        }

        function playSound(name) {
            if (!settings.sound) return;
            try {
                if (name === 'deal') playTone(430, 50, 0.03);
                else if (name === 'clear') { playTone(550, 70, 0.04); playTone(740, 80, 0.04, 0.06); }
                else if (name === 'error') playTone(210, 110, 0.045);
                else if (name === 'hint') playTone(360, 60, 0.025);
                else if (name === 'recycle') { playTone(300, 70, 0.03); playTone(420, 70, 0.03, 0.08); }
                else if (name === 'win') { playTone(520, 90, 0.05); playTone(780, 120, 0.05, 0.09); }
                else if (name === 'deadlock') playTone(250, 120, 0.04);
            } catch (_) { }
        }

        function toLocalDateKey(date = new Date()) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function addDays(dateKey, deltaDays) {
            if (!dateKey) return '';
            const date = new Date(`${dateKey}T00:00:00`);
            date.setDate(date.getDate() + deltaDays);
            return toLocalDateKey(date);
        }

        function loadAchievements() {
            try {
                const raw = localStorage.getItem(ACHIEVEMENTS_KEY);
                if (!raw) return { ...DEFAULT_ACHIEVEMENTS };
                const parsed = JSON.parse(raw);
                return {
                    wins: Number.isInteger(parsed.wins) ? parsed.wins : 0,
                    zeroClearWins: Number.isInteger(parsed.zeroClearWins) ? parsed.zeroClearWins : 0,
                    maxCombo: Number.isInteger(parsed.maxCombo) ? parsed.maxCombo : 0,
                    bestMoves: Number.isInteger(parsed.bestMoves) ? parsed.bestMoves : null,
                    bestTimeSec: Number.isInteger(parsed.bestTimeSec) ? parsed.bestTimeSec : null,
                    currentStreak: Number.isInteger(parsed.currentStreak) ? parsed.currentStreak : 0,
                    longestStreak: Number.isInteger(parsed.longestStreak) ? parsed.longestStreak : 0,
                    lastWinDate: typeof parsed.lastWinDate === 'string' ? parsed.lastWinDate : ''
                };
            } catch (_) {
                return { ...DEFAULT_ACHIEVEMENTS };
            }
        }

        function saveAchievements() {
            try {
                localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(achievements));
            } catch (_) { }
        }

        function updateAchievementsOnWin(current, kind = 'lucky3') {
            achievements.wins += 1;
            if (kind === 'zero-clear') achievements.zeroClearWins += 1;
            achievements.maxCombo = Math.max(achievements.maxCombo, current.maxCombo);
            achievements.bestMoves = achievements.bestMoves == null ? current.moveCount : Math.min(achievements.bestMoves, current.moveCount);
            achievements.bestTimeSec = achievements.bestTimeSec == null ? current.elapsedSec : Math.min(achievements.bestTimeSec, current.elapsedSec);

            const today = toLocalDateKey();
            if (achievements.lastWinDate !== today) {
                const yesterday = addDays(today, -1);
                if (achievements.lastWinDate === yesterday) achievements.currentStreak += 1;
                else achievements.currentStreak = 1;
                achievements.longestStreak = Math.max(achievements.longestStreak, achievements.currentStreak);
                achievements.lastWinDate = today;
            }

            saveAchievements();
        }

        function achievementBadgeRows() {
            const rows = [
                {
                    title: 'ÈÄ£ÊìäÈ´òÊâã',
                    ok: achievements.maxCombo >= 5,
                    text: achievements.maxCombo >= 5 ? `Â∑≤ÈÅîÊàêÔºöÊúÄÈ´òÈÄ£Êìä ${achievements.maxCombo}` : `ÈÄ≤Â∫¶ÔºöÊúÄÈ´òÈÄ£Êìä ${achievements.maxCombo} / 5`
                },
                {
                    title: 'Âø´ÊâãÁé©ÂÆ∂',
                    ok: achievements.bestMoves != null && achievements.bestMoves <= 18,
                    text: achievements.bestMoves == null ? 'ÈÄ≤Â∫¶ÔºöÂ∞öÊú™ÂÆåÊàêÁâåÂ±Ä' : `ÈÄ≤Â∫¶ÔºöÊúÄÁü≠ ${achievements.bestMoves} Ê≠•ÔºàÁõÆÊ®ô 18Ôºâ`
                },
                {
                    title: 'Á©©ÂÆöÈÄ£Âãù',
                    ok: achievements.longestStreak >= 3,
                    text: `ÈÄ≤Â∫¶ÔºöÊúÄÈï∑ÈÄ£Âãù ${achievements.longestStreak} Â§©ÔºàÁõÆÊ®ô 3Ôºâ`
                },
                {
                    title: 'ËÄÅÁ∑¥Áé©ÂÆ∂',
                    ok: achievements.wins >= 10,
                    text: `ÈÄ≤Â∫¶ÔºöÁ¥ØË®àÂãùÂà© ${achievements.wins} / 10`
                },
                {
                    title: 'ËôõÁ©∫Êî∂Êùü',
                    ok: achievements.zeroClearWins >= 1,
                    text: achievements.zeroClearWins >= 1 ? `Â∑≤ÈÅîÊàêÔºöÂÖ®Ê∏ÖÈõ∂ ${achievements.zeroClearWins} Ê¨°` : 'ÈÄ≤Â∫¶ÔºöÂÆåÊàê 1 Ê¨°ÂÖ®Ê∏ÖÈõ∂ÁµêÂ±Ä'
                }
            ];
            return rows;
        }

        function renderAchievements() {
            const grid = document.getElementById('achievement-grid');
            const badges = document.getElementById('achievement-badges');
            if (!grid || !badges) return;

            grid.innerHTML = `
                <div class="achievement-stat"><div class="achievement-stat-label">Á¥ØË®àÂãùÂà©</div><div class="achievement-stat-value">${achievements.wins}</div></div>
                <div class="achievement-stat"><div class="achievement-stat-label">ÂÖ®Ê∏ÖÈõ∂ÂãùÂà©</div><div class="achievement-stat-value">${achievements.zeroClearWins}</div></div>
                <div class="achievement-stat"><div class="achievement-stat-label">ÁõÆÂâçÈÄ£Âãù</div><div class="achievement-stat-value">${achievements.currentStreak} Â§©</div></div>
                <div class="achievement-stat"><div class="achievement-stat-label">ÊúÄÈï∑ÈÄ£Âãù</div><div class="achievement-stat-value">${achievements.longestStreak} Â§©</div></div>
                <div class="achievement-stat"><div class="achievement-stat-label">ÊúÄÈ´òÈÄ£Êìä</div><div class="achievement-stat-value">${achievements.maxCombo}</div></div>
                <div class="achievement-stat"><div class="achievement-stat-label">ÊúÄÁü≠Ê≠•Êï∏</div><div class="achievement-stat-value">${achievements.bestMoves == null ? '-' : achievements.bestMoves}</div></div>
                <div class="achievement-stat"><div class="achievement-stat-label">ÊúÄÂø´ÊôÇÈñì</div><div class="achievement-stat-value">${achievements.bestTimeSec == null ? '-' : formatTime(achievements.bestTimeSec)}</div></div>
            `;

            badges.innerHTML = achievementBadgeRows().map((b) => `
                <div class="achievement-badge ${b.ok ? 'unlocked' : ''}">
                    <strong>${b.ok ? '‚úÖ' : '‚¨ú'} ${b.title}</strong><br>${b.text}
                </div>
            `).join('');
        }

        function openAchievements() {
            renderAchievements();
            const overlay = document.getElementById('achievement-overlay');
            if (!overlay) return;
            overlay.classList.add('show');
        }

        function closeAchievements() {
            const overlay = document.getElementById('achievement-overlay');
            if (!overlay) return;
            overlay.classList.remove('show');
        }

        function onAchievementOverlayClick(event) {
            if (event.target && event.target.id === 'achievement-overlay') {
                closeAchievements();
            }
        }

        function openAchievementsFromSettings() {
            toggleSettings(false);
            openAchievements();
        }

        // --- ÂàùÂßãÂåñËàáÈáçÁΩÆ ---
        function init(forceNew = false) {
            // Âº∑Âà∂Ëß£ÈéñÁãÄÊÖã
            isBusy = false;

            // Ê∏ÖÈô§ UI
            const fxLayer = document.getElementById('fx-layer');
            if (fxLayer) fxLayer.innerHTML = '';
            const bigMsg = document.querySelector('.big-msg');
            if (bigMsg) bigMsg.remove();
            const winOverlay = document.getElementById('win-overlay');
            if (winOverlay) winOverlay.remove();
            const deadlockOverlay = document.getElementById('deadlock-overlay');
            if (deadlockOverlay) deadlockOverlay.remove();
            if (winInterval) clearInterval(winInterval);

            if (!forceNew && loadGameState()) {
                document.getElementById('btn-undo').disabled = historyStack.length === 0;
                render();
                updateDiscard();
                if (!hasWon) checkDeadlock();
                return;
            }

            // ÈáçÁΩÆË≥áÊñô
            deck = [];
            discardPile = [];
            clearedGroups = [];
            if (tutorialDeckMode) {
                deck = buildTutorialDeck();
            } else {
                const pickedSeed = pickCuratedSeed();
                if (pickedSeed == null) {
                    const fullDeck = [];
                    suits.forEach(s => ranks.forEach(r => {
                        fullDeck.push({ rank: r, suit: s, val: r === 'A' ? 1 : parseInt(r), color: s === '‚ô•' || s === '‚ô¶' ? 'red' : 'black' });
                    }));
                    shuffleInPlace(fullDeck);
                    deck = fullDeck;
                } else {
                    deck = buildSeededDeck(pickedSeed);
                }
            }

            slots = [
                { id: 0, cards: [], active: true },
                { id: 1, cards: [], active: true },
                { id: 2, cards: [], active: true },
                { id: 3, cards: [], active: true }
            ];

            selected = [];
            nextSlotIndex = 0;
            historyStack = [];
            combo = 0;
            lastCleared = null;
            startTime = Date.now();
            moveCount = 0;
            maxCombo = 0;
            hasWon = false;
            deadlockShown = false;
            winCardSuit = '';

            // ÈáçÊñ∞Ê∏≤Êüì
            document.getElementById('btn-undo').disabled = true;
            render();
            updateDiscard();
            runOpeningDealAnimation(3).then(() => {
                updateDiscard();
                saveGameState();
                if (!hasWon) checkDeadlock();
                if (tutorialDeckMode) {
                    startTutorial(true);
                    tutorialDeckMode = false;
                } else {
                    startTutorial(false);
                }
            });
        }

        function resetGame() {
            openRestartConfirm();
        }

        function resetGameFromSettings() {
            toggleSettings(false);
            resetGame();
        }

        function openRestartConfirm() {
            const overlay = document.getElementById('restart-overlay');
            if (!overlay) return;
            overlay.classList.add('show');
        }

        function closeRestartConfirm() {
            const overlay = document.getElementById('restart-overlay');
            if (!overlay) return;
            overlay.classList.remove('show');
        }

        function onRestartOverlayClick(event) {
            if (event.target && event.target.id === 'restart-overlay') {
                closeRestartConfirm();
            }
        }

        function confirmRestartGame() {
            closeRestartConfirm();
            init(true);
        }

        // Ë®àÊôÇÂô® (Âè™ÈúÄÂú®È†ÅÈù¢Âä†ËºâÊôÇÂü∑Ë°å‰∏ÄÊ¨° setInterval)
        setInterval(() => {
            const sec = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('timer');
            if (timerEl) timerEl.innerText = `${m}:${s}`;
        }, 1000);

        // --- Ê†∏ÂøÉÊ∏≤Êüì ---
        function render() {
            const board = document.getElementById('board');
            board.innerHTML = ''; // ÂæπÂ∫ïÊ∏ÖÁ©∫Áï∂Ââç DOM

            slots.filter(s => s.active).forEach(slot => {
                const col = document.createElement('div');
                col.className = 'column'; col.id = `col-${slot.id}`;
                slot.cards.forEach((card, idx) => {
                    const div = document.createElement('div');
                    const selObj = selected.find(s => s.slotId === slot.id && s.idx === idx);
                    div.className = `card ${card.color} ${selObj ? 'selected' : ''}`;
                    // Keep original stack order stable even when selected.
                    div.style.zIndex = idx;
                    div.innerHTML = `<div style="font-weight:bold">${card.rank}</div><div style="align-self:center; font-size:1.6rem">${card.suit}</div>`;
                    div.onclick = () => {
                        if (isBusy) return;
                        const sIdx = selected.findIndex(s => s.slotId === slot.id && s.idx === idx);
                        if (sIdx > -1) selected.splice(sIdx, 1);
                        else {
                            if (selected.length > 0 && selected[0].slotId !== slot.id) selected = [];
                            if (selected.length < 3) selected.push({ slotId: slot.id, idx });
                        }

                        if (tutorial.active && tutorial.step === 2 && selected.length === 3) {
                            const picked = selected.map(s => s.idx);
                            const legal = isLegalSelectionPosition(slot.cards.length, picked);
                            if (legal) {
                                onTutorialEvent('selected_three');
                            } else {
                                showTutorialRuleHint();
                                setTimeout(() => {
                                    selected = [];
                                    render();
                                }, getDelay(650));
                                render();
                                return;
                            }
                        }
                        render();
                    };
                    col.appendChild(div);
                });
                board.appendChild(col);
            });
            document.getElementById('deck-num').innerText = deck.length;
        }

        // --- ÁâπÊïàÈÇèËºØ ---
        function showColumnClearFX(slotId) {
            const colEl = document.getElementById(`col-${slotId}`);
            if (!colEl) return;
            triggerHaptic([80, 50, 80]);
            const beam = document.createElement('div'); beam.className = 'column-beam';
            colEl.appendChild(beam);
            const text = document.createElement('div'); text.className = 'column-clear-text';
            text.innerText = 'COLUMN CLEAR!'; colEl.appendChild(text);
            const rect = colEl.getBoundingClientRect();
            for (let i = 0; i < 15; i++) spawnP(rect.left + rect.width / 2, rect.top + rect.height / 2);
            setTimeout(() => { if (beam.parentNode) beam.remove(); if (text.parentNode) text.remove(); }, getDelay(1200));
        }

        function showMiiFX(colEl) {
            if (!colEl) return;
            const existing = colEl.querySelector('.mii-text');
            if (existing) existing.remove();

            const text = document.createElement('div');
            text.className = 'mii-text';
            text.innerText = 'Âí™Áâå‰∏≠...';
            colEl.appendChild(text);
            triggerHaptic([25, 30, 25]);

            setTimeout(() => {
                if (text.parentNode) text.remove();
            }, getDelay(900));
        }

        function getDealTargetTop(colEl, existingCount) {
            if (!colEl || existingCount <= 0) return colEl?.getBoundingClientRect().top ?? 0;

            const lastCardEl = colEl.children[existingCount - 1];
            if (!lastCardEl) return colEl.getBoundingClientRect().top;

            const lastRect = lastCardEl.getBoundingClientRect();
            let step = 0;

            const getConfiguredGapPx = () => {
                if (window.innerWidth >= 450) return -85;
                const raw = getComputedStyle(document.documentElement).getPropertyValue('--fixed-gap').trim();
                if (raw.endsWith('vw')) {
                    const val = parseFloat(raw);
                    if (Number.isFinite(val)) return (window.innerWidth * val) / 100;
                }
                if (raw.endsWith('px')) {
                    const val = parseFloat(raw);
                    if (Number.isFinite(val)) return val;
                }
                return 0;
            };

            if (existingCount >= 2) {
                const prevCardEl = colEl.children[existingCount - 2];
                if (prevCardEl) {
                    const prevRect = prevCardEl.getBoundingClientRect();
                    step = lastRect.top - prevRect.top;
                }
            }

            // existingCount===1 ÊôÇÔºåÂîØ‰∏ÄÈÇ£Âºµ‰ªçÊòØ :last-childÔºåmargin-bottom ÊúÉÊòØ 0Ôºå
            // ÊúÉÂ∞éËá¥Á¨¨‰∫åÂºµËêΩÈªûÁÆóÂ§™‰ΩéÔºõÊîπÁî®ÈÖçÁΩÆÈñìË∑ùË®àÁÆóÔºåÈÅøÂÖçÁ¨¨‰∫åÂºµÂç°È†ì„ÄÇ
            if (!Number.isFinite(step) || step === 0 || existingCount === 1) {
                step = lastRect.height + getConfiguredGapPx();
            }

            return lastRect.top + step;
        }

        function popNewlyDealtCard(slotId) {
            const colEl = document.getElementById(`col-${slotId}`);
            if (!colEl || colEl.children.length === 0) return;
            const newest = colEl.children[colEl.children.length - 1];
            newest.classList.add('mii-land-pop');
            setTimeout(() => newest.classList.remove('mii-land-pop'), getDelay(460));
        }

        // --- ÁôºÁâåËàáÊ∂àÈô§ ---
        async function dealOneCard() {
            if (isBusy) return;

            // Â¶ÇÊûúÁâåÂ∫´Á©∫‰∫ÜÔºå‰ΩÜÂõûÊî∂ÂçÄÊúâÁâåÔºåÂâáÈÄ≤Ë°åÂõûÊî∂
            if (deck.length === 0 && clearedGroups.length > 0) {
                recycleDeck();
                return;
            }

            if (deck.length === 0) {
                checkDeadlock();
                return;
            }

            // DealÊôÇÂèñÊ∂àÈÅ∏Âèñ
            if (selected.length > 0) {
                selected = [];
                render();
            }

            const avail = slots.find((s, i) => slots[(nextSlotIndex + i) % 4].active);
            if (!avail) return;
            isBusy = true; combo = 0;
            const target = slots[(nextSlotIndex + slots.indexOf(avail)) % 4];
            const prevIdx = nextSlotIndex;
            nextSlotIndex = (slots.indexOf(target) + 1) % 4;

            historyStack.push({ type: 'deal', slotId: target.id, prevIdx });
            document.getElementById('btn-undo').disabled = false;
            moveCount++;
            playSound('deal');
            onTutorialEvent('deal');

            const card = deck.pop();
            const isMiiMoment = target.cards.length === 2;
            const fly = createFly(card, document.getElementById('deck-pile').getBoundingClientRect(), { hidden: isMiiMoment });
            render();
            const colEl = document.getElementById(`col-${target.id}`);
            const rect = colEl.getBoundingClientRect();
            const targetTop = getDealTargetTop(colEl, target.cards.length);

            requestAnimationFrame(() => {
                fly.style.left = rect.left + 'px';
                fly.style.top = targetTop + 'px';
            });

            if (isMiiMoment) {
                setTimeout(() => {
                    revealFlyCard(fly, card);
                    fly.classList.add('mii-peek');
                    showMiiFX(colEl);
                }, getDelay(760));

                setTimeout(() => {
                    target.cards.push(card);
                    fly.remove();
                    render();
                    popNewlyDealtCard(target.id);
                    isBusy = false;
                    checkDeadlock();
                    saveGameState();
                }, getDelay(1720));
            } else {
                setTimeout(() => {
                    target.cards.push(card);
                    fly.remove();
                    render();
                    isBusy = false;
                    checkDeadlock();
                    saveGameState();
                }, getDelay(400));
            }
        }

        function recycleDeck() {
            if (isBusy || clearedGroups.length === 0) return;
            isBusy = true;

            // È°ØÁ§∫ÈáçÊñ∞Ê¥óÁâåÁöÑÊèêÁ§∫
            const msg = document.createElement('div');
            msg.className = 'combo-text';
            msg.style.color = 'var(--gold)';
            msg.innerHTML = "RECYCLING...";
            document.getElementById('fx-layer').appendChild(msg);
            playSound('recycle');

            setTimeout(() => {
                // ÊåâÊ∂àÈô§ÁµÑÈ†ÜÂ∫èÂõûÊî∂ÔºöÁ¨¨‰∏ÄÁµÑÊ∂àÈô§ÁöÑÁâåÂõûÂà∞ÁâåÂ†ÜÊúÄ‰∏äÊñπÔºàÊúÄÂÖàË¢´ÊäΩÂà∞Ôºâ
                deck = [];
                for (let i = clearedGroups.length - 1; i >= 0; i--) {
                    deck.push(...clearedGroups[i]);
                }
                discardPile = [];
                clearedGroups = [];
                lastCleared = null;

                msg.remove();
                render();
                updateDiscard();
                isBusy = false;
                triggerHaptic([50, 50, 50]);
                checkDeadlock();
                saveGameState();
            }, getDelay(1000));
        }

        function showNeedThreeHint(selectedCount) {
            const old = document.getElementById('need-three-tip');
            if (old) old.remove();

            const msg = document.createElement('div');
            msg.id = 'need-three-tip';
            msg.className = 'need-three-tip';
            msg.innerText = selectedCount === 2 ? 'ÈÇÑÂ∑Æ 1 ÂºµÔºåÊâçËÉΩÊ∂à‰∏âÂºµ' : 'Ë´ãÂÖàÈÅ∏Êªø 3 ÂºµÁâå';
            document.body.appendChild(msg);

            const clearBtn = document.getElementById('btn-clear');
            if (clearBtn) {
                clearBtn.style.background = '#ad1457';
                setTimeout(() => { clearBtn.style.background = ''; }, getDelay(220));
            }

            triggerHaptic([18, 24, 18]);
            playSound('hint');
            setTimeout(() => {
                if (msg.parentNode) msg.remove();
            }, getDelay(980));
        }

        async function attemptClear() {
            if (isBusy) return;
            if (selected.length !== 3) {
                showNeedThreeHint(selected.length);
                return;
            }
            const slotId = selected[0].slotId; const slot = slots.find(s => s.id === slotId);
            const currentCards = [...slot.cards]; const sum = selected.reduce((a, c) => a + currentCards[c.idx].val, 0);
            const sortedIndices = selected.map(s => s.idx).sort((a, b) => a - b);
            const len = currentCards.length;
            const isPos = JSON.stringify(sortedIndices) === JSON.stringify([len - 3, len - 2, len - 1]) ||
                JSON.stringify(sortedIndices) === JSON.stringify([0, len - 2, len - 1]) ||
                JSON.stringify(sortedIndices) === JSON.stringify([0, 1, len - 1]);

            if ([9, 19, 29].includes(sum) && isPos) {
                onTutorialEvent('attempt_clear_success');
                isBusy = true;
                const colEl = document.getElementById(`col-${slotId}`);
                sortedIndices.forEach(idx => colEl.children[idx].classList.add('is-fading'));
                const clearedObjects = sortedIndices.map(idx => ({ idx: idx, data: { ...currentCards[idx] } }));
                historyStack.push({ type: 'clear', slotId, cards: clearedObjects, prevLast: lastCleared, comboBefore: combo });
                document.getElementById('btn-undo').disabled = false;
                const destRect = document.getElementById('discard-pile').getBoundingClientRect();
                lastCleared = currentCards[sortedIndices[sortedIndices.length - 1]];

                sortedIndices.forEach(idx => {
                    const fly = createFly(currentCards[idx], colEl.children[idx].getBoundingClientRect());
                    requestAnimationFrame(() => {
                        fly.style.left = destRect.left + 'px'; fly.style.top = destRect.top + 'px';
                        fly.style.transform = 'scale(0.5) rotate(20deg)'; fly.style.opacity = '0';
                    });
                    setTimeout(() => fly.remove(), getDelay(550));
                });

                setTimeout(() => {
                    const recycled = sortedIndices.map(i => slot.cards[i]);
                    discardPile.push(...recycled); // Áî®ÊñºÁõÆÂâçÂõûÊî∂ÂçÄÈ°ØÁ§∫
                    clearedGroups.push([...recycled]); // ‰øùÁïôÊØè‰∏ÄÁµÑÊ∂àÈô§È†ÜÂ∫è‰æõÂõûÊî∂ÁâåÂ†Ü‰ΩøÁî®
                    sortedIndices.sort((a, b) => b - a).forEach(i => slot.cards.splice(i, 1));
                    combo++; selected = [];
                    maxCombo = Math.max(maxCombo, combo);
                    moveCount++;
                    playSound('clear');
                    let colCleared = false; if (slot.cards.length === 0) { colCleared = true; showColumnClearFX(slotId); }

                    setTimeout(() => {
                        if (colCleared) slot.active = false;
                        render(); updateDiscard(); showCombo(sum); checkVictory(); isBusy = false;
                        if (!hasWon) checkDeadlock();
                        saveGameState();
                    }, colCleared ? getDelay(800) : 0);

                    triggerHaptic(sum === 29 ? [60, 40, 60] : 40);
                    if (sum === 29) spawnP(window.innerWidth / 2, window.innerHeight / 2);
                }, getDelay(400));
            } else {
                combo = 0; triggerHaptic(100);
                playSound('error');
                document.getElementById('btn-clear').style.background = '#c62828';
                setTimeout(() => document.getElementById('btn-clear').style.background = '', getDelay(300));

                const slotId = selected[0]?.slotId;
                const colEl = slotId != null ? document.getElementById(`col-${slotId}`) : null;
                selected.forEach(s => {
                    const cardEl = colEl?.children?.[s.idx];
                    if (cardEl) cardEl.classList.add('invalid-flash');
                });

                setTimeout(() => {
                    selected = [];
                    render();
                    checkDeadlock();
                    saveGameState();
                }, getDelay(760));
            }
        }

        function undo() {
            if (historyStack.length === 0 || isBusy) return;
            const last = historyStack.pop(); combo = last.comboBefore || 0;
            moveCount = Math.max(0, moveCount - 1);
            if (last.type === 'deal') {
                const s = slots.find(x => x.id === last.slotId); deck.push(s.cards.pop()); nextSlotIndex = last.prevIdx;
            } else {
                const s = slots.find(x => x.id === last.slotId); s.active = true;
                // ÂæûÂõûÊî∂Â†ÜÁßªÈô§ÊúÄÂæå‰∏âÂºµÁâå
                discardPile.splice(-3);
                clearedGroups.pop();
                last.cards.sort((a, b) => a.idx - b.idx).forEach(c => s.cards.splice(c.idx, 0, c.data));
                lastCleared = last.prevLast;
            }
            selected = []; render(); updateDiscard();
            if (historyStack.length === 0) document.getElementById('btn-undo').disabled = true;
            checkDeadlock();
            saveGameState();
        }

        function checkVictory() {
            if (hasWon) return;
            const all = slots.flatMap(s => s.cards);
            if (all.length === 0) {
                hasWon = true;
                setTimeout(() => {
                    showZeroClearWinPanel();
                    winInterval = setInterval(() => spawnP(Math.random() * window.innerWidth, Math.random() * window.innerHeight), 300);
                }, getDelay(500));
                return;
            }

            if (all.length === 1 && all[0].val === 3) {
                winCardSuit = all[0].suit;
                hasWon = true;
                setTimeout(() => {
                    const card = document.querySelector('.card'); if (card) card.classList.add('lucky-three-win');
                    showWinPanel();
                    winInterval = setInterval(() => spawnP(Math.random() * window.innerWidth, Math.random() * window.innerHeight), 300);
                }, getDelay(500));
            }
        }

        function showCombo(s) {
            if (combo < 2) return;
            const layer = document.getElementById('fx-layer');
            const comboDiv = document.createElement('div'); comboDiv.className = 'combo-text';
            comboDiv.innerHTML = `${combo} COMBO!<br><span style="font-size:1.2rem;color:var(--gold)">+${s} PTS</span>`;
            layer.appendChild(comboDiv); setTimeout(() => comboDiv.remove(), getDelay(1500));
        }

        function triggerHaptic(ms) { if (settings.vibration && navigator.vibrate) navigator.vibrate(ms); }

        function spawnP(x, y) {
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div'); p.className = 'particle'; p.style.left = x + 'px'; p.style.top = y + 'px';
                p.style.setProperty('--tx', (Math.random() - 0.5) * 400 + 'px'); p.style.setProperty('--ty', (Math.random() - 0.5) * 400 + 'px');
                document.getElementById('fx-layer').appendChild(p); setTimeout(() => p.remove(), getDelay(800));
            }
        }

        function setFlyFace(f, data) {
            f.classList.remove('face-down');
            f.classList.toggle('red', data.color === 'red');
            f.innerHTML = `<div style="font-weight:bold">${data.rank}</div><div style="align-self:center; font-size:1.6rem">${data.suit}</div>`;
        }

        function revealFlyCard(f, data) {
            setFlyFace(f, data);
        }

        function createFly(data, rect, options = {}) {
            const f = document.createElement('div');
            f.className = 'card flying';
            if (options.hidden) {
                f.classList.add('face-down');
                f.innerHTML = '';
            } else {
                setFlyFace(f, data);
            }
            f.style.left = rect.left + 'px';
            f.style.top = rect.top + 'px';
            document.body.appendChild(f);
            return f;
        }

        function updateDiscard() {
            const p = document.getElementById('discard-pile');
            if (lastCleared) {
                p.innerHTML = `<div style="font-size:10px; position:absolute; top:2px; left:4px;">${lastCleared.rank}</div><div style="font-size:14px;">${lastCleared.suit}</div>`;
                p.className = `pile has-cards ${lastCleared.color}`;
                p.style.boxShadow = `3px 3px 0 rgba(255,215,0,0.4)`;
            } else { p.className = 'pile'; p.innerHTML = ''; p.style.boxShadow = 'none'; }
        }

        function formatTime(totalSec) {
            const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
            const s = (totalSec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function loadBestStats() {
            try {
                const raw = localStorage.getItem('lucky3-best-stats');
                if (!raw) return { fastestTimeSec: null, fewestMoves: null, highestCombo: 0 };
                const parsed = JSON.parse(raw);
                return {
                    fastestTimeSec: Number.isFinite(parsed.fastestTimeSec) ? parsed.fastestTimeSec : null,
                    fewestMoves: Number.isFinite(parsed.fewestMoves) ? parsed.fewestMoves : null,
                    highestCombo: Number.isFinite(parsed.highestCombo) ? parsed.highestCombo : 0
                };
            } catch (_) {
                return { fastestTimeSec: null, fewestMoves: null, highestCombo: 0 };
            }
        }

        function saveBestStats(stats) {
            try {
                localStorage.setItem('lucky3-best-stats', JSON.stringify(stats));
            } catch (_) { }
        }

        function updateBestStats(current) {
            const best = loadBestStats();
            const isNewFastest = best.fastestTimeSec == null || current.elapsedSec < best.fastestTimeSec;
            const isNewFewestMoves = best.fewestMoves == null || current.moveCount < best.fewestMoves;
            const isNewHighestCombo = current.maxCombo > (best.highestCombo || 0);

            const nextBest = {
                fastestTimeSec: isNewFastest ? current.elapsedSec : best.fastestTimeSec,
                fewestMoves: isNewFewestMoves ? current.moveCount : best.fewestMoves,
                highestCombo: isNewHighestCombo ? current.maxCombo : best.highestCombo
            };
            saveBestStats(nextBest);

            return {
                best: nextBest,
                flags: { isNewFastest, isNewFewestMoves, isNewHighestCombo }
            };
        }

        function buildBestMessage(result) {
            const flags = result.flags;
            if (flags.isNewFastest) return `üéâ Êú¨Â±ÄÊúÄ‰Ω≥ÊàêÁ∏æÔºöÁ†¥Ëá™Â∑±ÊúÄÂø´ÊôÇÈñìÔºà${formatTime(result.best.fastestTimeSec)}Ôºâ`;
            if (flags.isNewFewestMoves) return `‚ú® Êú¨Â±ÄÊúÄ‰Ω≥ÊàêÁ∏æÔºöÂà∑Êñ∞ÊúÄÂ∞ëÊ≠•Êï∏Ôºà${result.best.fewestMoves} Ê≠•Ôºâ`;
            if (flags.isNewHighestCombo) return `üî• Êú¨Â±ÄÊúÄ‰Ω≥ÊàêÁ∏æÔºöÂà∑Êñ∞ÊúÄÈ´òÈÄ£ÊìäÔºà${result.best.highestCombo}Ôºâ`;
            return `ÊúÄ‰Ω≥Á¥ÄÈåÑÔºöÊúÄÂø´ ${formatTime(result.best.fastestTimeSec || 0)} / ÊúÄÂ∞ë ${result.best.fewestMoves || 0} Ê≠•`;
        }

        function showWinPanel() {
            const old = document.getElementById('win-overlay');
            if (old) old.remove();

            const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
            const todayKey = toLocalDateKey();
            const isFirstWinToday = achievements.lastWinDate !== todayKey;
            const fortuneText = isFirstWinToday ? fortuneBySuit(winCardSuit) : '';
            const bestResult = updateBestStats({ elapsedSec, moveCount, maxCombo });
            updateAchievementsOnWin({ elapsedSec, moveCount, maxCombo }, 'lucky3');
            const bestMessage = buildBestMessage(bestResult);
            playSound('win');
            const overlay = document.createElement('div');
            overlay.className = 'win-overlay';
            overlay.id = 'win-overlay';
            overlay.innerHTML = `
                <div class="win-panel">
                    <h2 class="win-title">LUCKY 3 JACKPOT</h2>
                    <p class="win-subtitle">Ë∂ÖËÆöÔºÅ‰Ω†ÊääÁâåÂ±ÄÊî∂‰πæÊ∑®‰∫Ü ‚ú®</p>
                    <div class="win-stats">
                        <div class="win-stat-row"><span>Áî®ÊôÇ</span><strong>${formatTime(elapsedSec)}</strong></div>
                        <div class="win-stat-row"><span>Á∏ΩÊ≠•Êï∏</span><strong>${moveCount}</strong></div>
                        <div class="win-stat-row"><span>ÊúÄÈ´òÈÄ£Êìä</span><strong>${maxCombo}</strong></div>
                    </div>
                    ${fortuneText ? `<p class="win-fortune">${fortuneText}</p>` : ''}
                    <p class="win-best">${bestMessage}</p>
                    <button type="button" class="win-play-again" onclick="playAgain()">ÂÜç‰æÜ‰∏ÄÂ±Ä</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function showZeroClearWinPanel() {
            const old = document.getElementById('win-overlay');
            if (old) old.remove();

            const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
            const bestResult = updateBestStats({ elapsedSec, moveCount, maxCombo });
            updateAchievementsOnWin({ elapsedSec, moveCount, maxCombo }, 'zero-clear');
            const bestMessage = buildBestMessage(bestResult);
            playSound('win');
            const overlay = document.createElement('div');
            overlay.className = 'win-overlay';
            overlay.id = 'win-overlay';
            overlay.innerHTML = `
                <div class="void-win-panel">
                    <h2 class="void-win-title">VOID CLEAR</h2>
                    <p class="void-win-subtitle">‰Ω†ÂÆåÊàê‰∫ÜÁ®ÄÊúâÁµêÂ±ÄÔºöÂ†¥‰∏ä 0 ÂºµÁâåÔºÅ<br>ÈÄôÊòØ‰∏ÄÂ†¥Ë∂ÖÈ´òÈõ£Â∫¶ÁöÑÂÆåÁæéÊî∂Êùü„ÄÇ</p>
                    <p class="void-win-badge">üèÜ Ëß£ÈéñÊàêÂ∞±ÔºöËôõÁ©∫Êî∂Êùü</p>
                    <div class="win-stats">
                        <div class="win-stat-row"><span>Áî®ÊôÇ</span><strong>${formatTime(elapsedSec)}</strong></div>
                        <div class="win-stat-row"><span>Á∏ΩÊ≠•Êï∏</span><strong>${moveCount}</strong></div>
                        <div class="win-stat-row"><span>ÊúÄÈ´òÈÄ£Êìä</span><strong>${maxCombo}</strong></div>
                    </div>
                    <p class="win-best">${bestMessage}</p>
                    <button type="button" class="win-play-again" onclick="playAgain()">ÂÜç‰æÜ‰∏ÄÂ±Ä</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function playAgain() {
            init(true);
        }

        function hasLegalClearInSlot(cards) {
            const len = cards.length;
            if (len < 3) return false;

            const candidates = [
                [len - 3, len - 2, len - 1],
                [0, len - 2, len - 1],
                [0, 1, len - 1]
            ];
            const uniqueCandidates = [...new Set(candidates.map(c => JSON.stringify(c)))].map(x => JSON.parse(x));

            return uniqueCandidates.some(indices => {
                if (indices.some(i => i < 0 || i >= len)) return false;
                const sum = indices.reduce((acc, i) => acc + cards[i].val, 0);
                return [9, 19, 29].includes(sum);
            });
        }

        function hasAnyLegalClear() {
            return slots.some(s => s.active && hasLegalClearInSlot(s.cards));
        }

        function hideDeadlockOverlay() {
            const overlay = document.getElementById('deadlock-overlay');
            if (overlay) overlay.remove();
            deadlockShown = false;
        }

        function showDeadlockOverlay() {
            if (deadlockShown) return;
            const old = document.getElementById('deadlock-overlay');
            if (old) old.remove();

            const canUndo = historyStack.length > 0;
            const overlay = document.createElement('div');
            overlay.className = 'deadlock-overlay';
            overlay.id = 'deadlock-overlay';
            overlay.innerHTML = `
                <div class="deadlock-panel">
                    <h3 class="deadlock-title">Âç°‰Ωè‰∫ÜÔºÅÁõÆÂâçÁÑ°ÂêàÊ≥ïÊ∂àÈô§</h3>
                    <p class="deadlock-text">ÁâåÂ∫´Â∑≤Á©∫Ôºå‰∏îÂ†¥‰∏äÊ≤íÊúâÂèØÊ∂àÈô§ÁöÑ 9 / 19 / 29 ÁµÑÂêà„ÄÇ‰Ω†ÊÉ≥Ë¶ÅÂÄíËΩâ‰∏ÄÊ≠•ÔºåÈÇÑÊòØÁõ¥Êé•ÈñãÊñ∞Â±ÄÔºü</p>
                    <div class="deadlock-actions">
                        <button type="button" class="deadlock-btn undo" onclick="resolveDeadlock('undo')" ${canUndo ? '' : 'disabled'}>ÂÄíËΩâ‰∏ÄÊ≠•</button>
                        <button type="button" class="deadlock-btn new" onclick="resolveDeadlock('new')">ÈñãÊñ∞Â±Ä</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            deadlockShown = true;
            triggerHaptic([80, 50, 80]);
            playSound('deadlock');
        }

        function resolveDeadlock(action) {
            hideDeadlockOverlay();
            if (action === 'undo') {
                undo();
                return;
            }
            if (action === 'new') {
                init(true);
            }
        }

        function checkDeadlock() {
            if (hasWon || isBusy) return false;

            if (deck.length > 0 || clearedGroups.length > 0) {
                hideDeadlockOverlay();
                return false;
            }

            if (hasAnyLegalClear()) {
                hideDeadlockOverlay();
                return false;
            }

            showDeadlockOverlay();
            return true;
        }

        function buildSavePayload() {
            const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
            return {
                deck,
                slots,
                discardPile,
                clearedGroups,
                nextSlotIndex,
                historyStack,
                combo,
                lastCleared,
                moveCount,
                maxCombo,
                hasWon,
                elapsedSec
            };
        }

        function isValidCard(card) {
            return card && typeof card.rank === 'string' && typeof card.suit === 'string' && Number.isFinite(card.val) &&
                (card.color === 'red' || card.color === 'black');
        }

        function isValidSlot(slot) {
            return slot && Number.isInteger(slot.id) && Array.isArray(slot.cards) && typeof slot.active === 'boolean' &&
                slot.cards.every(isValidCard);
        }

        function saveGameState() {
            try {
                localStorage.setItem(GAME_STATE_KEY, JSON.stringify(buildSavePayload()));
            } catch (_) { }
        }

        function loadGameState() {
            try {
                const raw = localStorage.getItem(GAME_STATE_KEY);
                if (!raw) return false;
                const parsed = JSON.parse(raw);

                if (!Array.isArray(parsed.deck) || !Array.isArray(parsed.slots) || !Array.isArray(parsed.discardPile) || !Array.isArray(parsed.clearedGroups)) return false;
                if (!parsed.deck.every(isValidCard) || !parsed.discardPile.every(isValidCard)) return false;
                if (!parsed.slots.every(isValidSlot)) return false;
                if (!parsed.clearedGroups.every(group => Array.isArray(group) && group.every(isValidCard))) return false;

                deck = parsed.deck;
                slots = parsed.slots;
                discardPile = parsed.discardPile;
                clearedGroups = parsed.clearedGroups;
                nextSlotIndex = Number.isInteger(parsed.nextSlotIndex) ? parsed.nextSlotIndex : 0;
                historyStack = Array.isArray(parsed.historyStack) ? parsed.historyStack : [];
                combo = Number.isInteger(parsed.combo) ? parsed.combo : 0;
                lastCleared = parsed.lastCleared && isValidCard(parsed.lastCleared) ? parsed.lastCleared : null;
                moveCount = Number.isInteger(parsed.moveCount) ? parsed.moveCount : 0;
                maxCombo = Number.isInteger(parsed.maxCombo) ? parsed.maxCombo : 0;
                hasWon = Boolean(parsed.hasWon);
                deadlockShown = false;
                selected = [];
                const elapsedSec = Number.isFinite(parsed.elapsedSec) ? Math.max(0, parsed.elapsedSec) : 0;
                startTime = Date.now() - elapsedSec * 1000;
                return true;
            } catch (_) {
                return false;
            }
        }

        window.addEventListener('beforeunload', saveGameState);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) saveGameState();
        });

        settings = loadSettings();
        achievements = loadAchievements();
        bindSettingsUI();
        applySettings();
        if (!isTutorialDismissed()) {
            tutorialDeckMode = true;
            init(true);
        } else {
            init();
        }
    </script>
</body>

</html>
