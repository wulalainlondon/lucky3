<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Lucky 3 Solitaire</title>
    <style>
        :root {
            --bg-green: #0a3d1d;
            --card-w: 20vw;
            --card-h: 28vw;
            --max-w: 80px;
            --max-h: 115px;
            --gold: #ffd700;
            --fixed-gap: -22vw;
        }

        body {
            font-family: 'Arial Black', sans-serif;
            background: #051d0e;
            margin: 0;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden;
            touch-action: manipulation;
        }

        #header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            border-bottom: 2px solid var(--gold);
        }

        #board {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 8px;
            padding: 20px 5px;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .column {
            display: flex;
            flex-direction: column;
            width: var(--card-w);
            max-width: var(--max-w);
            min-height: 120px;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .card {
            width: var(--card-w);
            height: var(--card-h);
            max-width: var(--max-w);
            max-height: var(--max-h);
            background: white;
            border-radius: 6px;
            color: black;
            position: relative;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
            transition: transform 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex;
            flex-direction: column;
            padding: 6px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            margin-bottom: var(--fixed-gap);
        }

        @media (min-width: 450px) {
            .card {
                margin-bottom: -85px;
            }
        }

        .card:last-child {
            margin-bottom: 0;
        }

        .card.red {
            color: #d32f2f;
        }

        .card.is-fading {
            opacity: 0 !important;
            visibility: hidden;
        }

        .card.selected {
            transform: translateX(40%) rotate(3deg);
            z-index: 500 !important;
            outline: 3px solid var(--gold);
            filter: brightness(1.1);
        }

        /* --- ç‰¹æ•ˆå±¤ --- */
        #fx-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .column-beam {
            position: absolute;
            width: 100%;
            height: 200vh;
            top: -50vh;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.8), transparent);
            box-shadow: 0 0 30px white;
            animation: beam-out 0.8s ease-out forwards;
        }

        @keyframes beam-out {
            0% {
                scaleX(0);
                opacity: 0;
            }

            20% {
                scaleX(1.5);
                opacity: 1;
            }

            100% {
                scaleX(0);
                opacity: 0;
            }
        }

        .column-clear-text {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 1rem;
            color: #fff;
            text-shadow: 0 0 10px var(--gold);
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
            animation: text-float-up 1.2s ease-out forwards;
        }

        @keyframes text-float-up {
            0% {
                transform: translate(-50%, 0);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -120px);
                opacity: 0;
            }
        }

        .combo-text {
            position: fixed;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.2rem;
            color: #fff;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 165, 0, 0.6);
            z-index: 10000;
            animation: combo-fancy 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes combo-fancy {
            0% {
                scale: 0.5;
                opacity: 0;
            }

            15% {
                scale: 1.2;
                opacity: 1;
            }

            75% {
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
        }

        .lucky-three-win {
            animation: win-glow 1s infinite alternate;
            z-index: 1000 !important;
        }

        @keyframes win-glow {
            from {
                transform: scale(1.2);
                box-shadow: 0 0 20px var(--gold);
            }

            to {
                transform: scale(1.4) rotate(10deg);
                box-shadow: 0 0 50px white, 0 0 100px var(--gold);
            }
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--gold);
            animation: p-fly 0.8s forwards;
        }

        @keyframes p-fly {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        /* Footer */
        #footer {
            background: rgba(0, 0, 0, 0.95);
            padding: 15px 10px calc(15px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--gold);
        }

        .pile {
            width: 55px;
            height: 75px;
            border-radius: 5px;
            border: 1px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #deck-pile {
            background: #1e88e5;
            box-shadow: 3px 3px 0 #0d47a1;
            cursor: pointer;
            font-size: 26px;
        }

        #discard-pile {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--gold);
        }

        .has-cards {
            background: white !important;
            color: black;
            border: 1px solid #999 !important;
        }

        .btn-main {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px #000;
            cursor: pointer;
        }

        #btn-undo {
            background: #455a64;
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            box-shadow: 0 4px #263238;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #btn-undo svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        #btn-undo:disabled {
            opacity: 0.2;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-main:active {
            transform: translateY(2px);
            box-shadow: 0 2px #1b5e20;
        }

        .flying {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .big-msg {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: var(--gold);
            text-align: center;
            z-index: 10001;
        }
    </style>
</head>

<body>

    <div id="header">
        <div style="font-size: 10px;">DECK: <b id="deck-num">40</b></div>
        <div style="color: var(--gold); letter-spacing: 2px;">LUCKY 3</div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div id="timer" style="font-size: 10px;">00:00</div>
            <div onclick="resetGame()"
                style="font-size: 10px; background: #c62828; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                RESTART</div>
        </div>
    </div>

    <div id="board"></div>
    <div id="fx-layer"></div>

    <div id="footer">
        <!-- ç™¼ç‰Œ -->
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div class="pile" id="deck-pile" onclick="dealOneCard()">ðŸ‚ </div>
            <div style="font-size: 10px; color: var(--gold); margin-top: 5px;">DEAL</div>
        </div>

        <!-- ä¸­é–“æŒ‰éˆ• -->
        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="btn-undo" class="btn-main" onclick="undo()" disabled aria-label="Undo">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12.5 8c-2.65 0-5.05 1-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" />
                </svg>
            </button>
            <button id="btn-clear" class="btn-main" onclick="attemptClear()">CLEAR</button>
        </div>

        <!-- å›žæ”¶ -->
        <div style="text-align: center;">
            <div class="pile" id="discard-pile"></div>
            <div style="font-size: 10px; color: var(--gold); margin-top: 5px;">RECYCLE</div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => { });
        }

        const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'], ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
        let deck = [], slots = [], discardPile = [];
        let selected = [], nextSlotIndex = 0, isBusy = false, historyStack = [], combo = 0, lastCleared = null, startTime = Date.now();
        let winInterval = null;

        // --- åˆå§‹åŒ–èˆ‡é‡ç½® ---
        function init() {
            // å¼·åˆ¶è§£éŽ–ç‹€æ…‹
            isBusy = false;

            // æ¸…é™¤ UI
            const fxLayer = document.getElementById('fx-layer');
            if (fxLayer) fxLayer.innerHTML = '';
            const bigMsg = document.querySelector('.big-msg');
            if (bigMsg) bigMsg.remove();
            if (winInterval) clearInterval(winInterval);

            // é‡ç½®è³‡æ–™
            deck = [];
            discardPile = [];
            suits.forEach(s => ranks.forEach(r => deck.push({ rank: r, suit: s, val: r === 'A' ? 1 : parseInt(r), color: s === 'â™¥' || s === 'â™¦' ? 'red' : 'black' })));
            deck.sort(() => Math.random() - 0.5);

            slots = [
                { id: 0, cards: [], active: true },
                { id: 1, cards: [], active: true },
                { id: 2, cards: [], active: true },
                { id: 3, cards: [], active: true }
            ];

            selected = [];
            nextSlotIndex = 0;
            historyStack = [];
            combo = 0;
            lastCleared = null;
            startTime = Date.now();

            // é‡æ–°æ¸²æŸ“
            document.getElementById('btn-undo').disabled = true;
            render();
            updateDiscard();
        }

        function resetGame() {
            if (confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹å—Žï¼Ÿæ‰€æœ‰é€²åº¦å°‡æœƒéºå¤±ã€‚")) {
                init();
            }
        }

        // è¨ˆæ™‚å™¨ (åªéœ€åœ¨é é¢åŠ è¼‰æ™‚åŸ·è¡Œä¸€æ¬¡ setInterval)
        setInterval(() => {
            const sec = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('timer');
            if (timerEl) timerEl.innerText = `${m}:${s}`;
        }, 1000);

        // --- æ ¸å¿ƒæ¸²æŸ“ ---
        function render() {
            const board = document.getElementById('board');
            board.innerHTML = ''; // å¾¹åº•æ¸…ç©ºç•¶å‰ DOM

            slots.filter(s => s.active).forEach(slot => {
                const col = document.createElement('div');
                col.className = 'column'; col.id = `col-${slot.id}`;
                slot.cards.forEach((card, idx) => {
                    const div = document.createElement('div');
                    const selObj = selected.find(s => s.slotId === slot.id && s.idx === idx);
                    div.className = `card ${card.color} ${selObj ? 'selected' : ''}`;
                    div.style.zIndex = selObj ? 600 : idx;
                    div.innerHTML = `<div style="font-weight:bold">${card.rank}</div><div style="align-self:center; font-size:1.6rem">${card.suit}</div>`;
                    div.onclick = () => {
                        if (isBusy) return;
                        const sIdx = selected.findIndex(s => s.slotId === slot.id && s.idx === idx);
                        if (sIdx > -1) selected.splice(sIdx, 1);
                        else {
                            if (selected.length > 0 && selected[0].slotId !== slot.id) selected = [];
                            if (selected.length < 3) selected.push({ slotId: slot.id, idx });
                        }
                        render();
                    };
                    col.appendChild(div);
                });
                board.appendChild(col);
            });
            document.getElementById('deck-num').innerText = deck.length;
        }

        // --- ç‰¹æ•ˆé‚è¼¯ ---
        function showColumnClearFX(slotId) {
            const colEl = document.getElementById(`col-${slotId}`);
            if (!colEl) return;
            triggerHaptic([80, 50, 80]);
            const beam = document.createElement('div'); beam.className = 'column-beam';
            colEl.appendChild(beam);
            const text = document.createElement('div'); text.className = 'column-clear-text';
            text.innerText = 'COLUMN CLEAR!'; colEl.appendChild(text);
            const rect = colEl.getBoundingClientRect();
            for (let i = 0; i < 15; i++) spawnP(rect.left + rect.width / 2, rect.top + rect.height / 2);
            setTimeout(() => { if (beam.parentNode) beam.remove(); if (text.parentNode) text.remove(); }, 1200);
        }

        // --- ç™¼ç‰Œèˆ‡æ¶ˆé™¤ ---
        async function dealOneCard() {
            if (isBusy) return;

            // å¦‚æžœç‰Œåº«ç©ºäº†ï¼Œä½†å›žæ”¶å€æœ‰ç‰Œï¼Œå‰‡é€²è¡Œå›žæ”¶
            if (deck.length === 0 && discardPile.length > 0) {
                recycleDeck();
                return;
            }

            if (deck.length === 0) return;

            const avail = slots.find((s, i) => slots[(nextSlotIndex + i) % 4].active);
            if (!avail) return;
            isBusy = true; combo = 0;
            const target = slots[(nextSlotIndex + slots.indexOf(avail)) % 4];
            const prevIdx = nextSlotIndex;
            nextSlotIndex = (slots.indexOf(target) + 1) % 4;

            historyStack.push({ type: 'deal', slotId: target.id, prevIdx });
            document.getElementById('btn-undo').disabled = false;

            const card = deck.pop();
            const fly = createFly(card, document.getElementById('deck-pile').getBoundingClientRect());
            render();
            const colEl = document.getElementById(`col-${target.id}`);
            const rect = colEl.getBoundingClientRect();
            const offset = (target.cards.length) * (window.innerWidth > 450 ? 30 : window.innerWidth * 0.08);

            requestAnimationFrame(() => {
                fly.style.left = rect.left + 'px'; fly.style.top = (rect.top + offset) + 'px';
            });

            setTimeout(() => {
                target.cards.push(card); fly.remove(); render(); isBusy = false;
            }, 400);
        }

        function recycleDeck() {
            if (isBusy || discardPile.length === 0) return;
            isBusy = true;

            // é¡¯ç¤ºé‡æ–°æ´—ç‰Œçš„æç¤º
            const msg = document.createElement('div');
            msg.className = 'combo-text';
            msg.style.color = 'var(--gold)';
            msg.innerHTML = "RESHUFFLING...";
            document.getElementById('fx-layer').appendChild(msg);

            setTimeout(() => {
                // å°‡å›žæ”¶å€çš„ç‰Œç§»å›žç‰Œåº«ä¸¦æ´—ç‰Œ
                deck = [...discardPile];
                deck.sort(() => Math.random() - 0.5);
                discardPile = [];
                lastCleared = null;

                msg.remove();
                render();
                updateDiscard();
                isBusy = false;
                triggerHaptic([50, 50, 50]);
            }, 1000);
        }

        async function attemptClear() {
            if (selected.length !== 3 || isBusy) return;
            const slotId = selected[0].slotId; const slot = slots.find(s => s.id === slotId);
            const currentCards = [...slot.cards]; const sum = selected.reduce((a, c) => a + currentCards[c.idx].val, 0);
            const sortedIndices = selected.map(s => s.idx).sort((a, b) => a - b);
            const len = currentCards.length;
            const isPos = JSON.stringify(sortedIndices) === JSON.stringify([len - 3, len - 2, len - 1]) ||
                JSON.stringify(sortedIndices) === JSON.stringify([0, len - 2, len - 1]) ||
                JSON.stringify(sortedIndices) === JSON.stringify([0, 1, len - 1]);

            if ([9, 19, 29].includes(sum) && isPos) {
                isBusy = true;
                const colEl = document.getElementById(`col-${slotId}`);
                sortedIndices.forEach(idx => colEl.children[idx].classList.add('is-fading'));
                const clearedObjects = sortedIndices.map(idx => ({ idx: idx, data: { ...currentCards[idx] } }));
                historyStack.push({ type: 'clear', slotId, cards: clearedObjects, prevLast: lastCleared, comboBefore: combo });
                document.getElementById('btn-undo').disabled = false;
                const destRect = document.getElementById('discard-pile').getBoundingClientRect();
                lastCleared = currentCards[sortedIndices[sortedIndices.length - 1]];

                sortedIndices.forEach(idx => {
                    const fly = createFly(currentCards[idx], colEl.children[idx].getBoundingClientRect());
                    requestAnimationFrame(() => {
                        fly.style.left = destRect.left + 'px'; fly.style.top = destRect.top + 'px';
                        fly.style.transform = 'scale(0.5) rotate(20deg)'; fly.style.opacity = '0';
                    });
                    setTimeout(() => fly.remove(), 550);
                });

                setTimeout(() => {
                    const recycled = sortedIndices.map(i => slot.cards[i]);
                    discardPile.push(...recycled); // æ”¹ç‚ºåŠ å…¥å›žæ”¶å †è€Œéžç›´æŽ¥å›žç‰Œåº«
                    sortedIndices.sort((a, b) => b - a).forEach(i => slot.cards.splice(i, 1));
                    combo++; selected = [];
                    let colCleared = false; if (slot.cards.length === 0) { colCleared = true; showColumnClearFX(slotId); }

                    setTimeout(() => {
                        if (colCleared) slot.active = false;
                        render(); updateDiscard(); showCombo(sum); checkLucky3(); isBusy = false;
                    }, colCleared ? 800 : 0);

                    if (navigator.vibrate) navigator.vibrate(sum === 29 ? [60, 40, 60] : 40);
                    if (sum === 29) spawnP(window.innerWidth / 2, window.innerHeight / 2);
                }, 400);
            } else {
                combo = 0; triggerHaptic(100);
                document.getElementById('btn-clear').style.background = '#c62828';
                setTimeout(() => document.getElementById('btn-clear').style.background = '', 300);
            }
        }

        function undo() {
            if (historyStack.length === 0 || isBusy) return;
            const last = historyStack.pop(); combo = last.comboBefore || 0;
            if (last.type === 'deal') {
                const s = slots.find(x => x.id === last.slotId); deck.push(s.cards.pop()); nextSlotIndex = last.prevIdx;
            } else {
                const s = slots.find(x => x.id === last.slotId); s.active = true;
                // å¾žå›žæ”¶å †ç§»é™¤æœ€å¾Œä¸‰å¼µç‰Œ
                discardPile.splice(-3);
                last.cards.sort((a, b) => a.idx - b.idx).forEach(c => s.cards.splice(c.idx, 0, c.data));
                lastCleared = last.prevLast;
            }
            selected = []; render(); updateDiscard();
            if (historyStack.length === 0) document.getElementById('btn-undo').disabled = true;
        }

        function checkLucky3() {
            const all = slots.flatMap(s => s.cards);
            if (deck.length === 0 && all.length === 1 && all[0].val === 3) {
                setTimeout(() => {
                    const card = document.querySelector('.card'); if (card) card.classList.add('lucky-three-win');
                    const msg = document.createElement('div'); msg.className = 'big-msg';
                    msg.innerHTML = "LUCKY 3!<br>JACKPOT"; document.body.appendChild(msg);
                    winInterval = setInterval(() => spawnP(Math.random() * window.innerWidth, Math.random() * window.innerHeight), 300);
                }, 500);
            }
        }

        function showCombo(s) {
            if (combo < 2) return;
            const layer = document.getElementById('fx-layer');
            const comboDiv = document.createElement('div'); comboDiv.className = 'combo-text';
            comboDiv.innerHTML = `${combo} COMBO!<br><span style="font-size:1.2rem;color:var(--gold)">+${s} PTS</span>`;
            layer.appendChild(comboDiv); setTimeout(() => comboDiv.remove(), 1500);
        }

        function triggerHaptic(ms) { if (navigator.vibrate) navigator.vibrate(ms); }

        function spawnP(x, y) {
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div'); p.className = 'particle'; p.style.left = x + 'px'; p.style.top = y + 'px';
                p.style.setProperty('--tx', (Math.random() - 0.5) * 400 + 'px'); p.style.setProperty('--ty', (Math.random() - 0.5) * 400 + 'px');
                document.getElementById('fx-layer').appendChild(p); setTimeout(() => p.remove(), 800);
            }
        }

        function createFly(data, rect) {
            const f = document.createElement('div'); f.className = 'card flying ' + data.color;
            f.innerHTML = `<div style="font-weight:bold">${data.rank}</div><div style="align-self:center; font-size:1.6rem">${data.suit}</div>`;
            f.style.left = rect.left + 'px'; f.style.top = rect.top + 'px'; document.body.appendChild(f); return f;
        }

        function updateDiscard() {
            const p = document.getElementById('discard-pile');
            if (lastCleared) {
                p.innerHTML = `<div style="font-size:10px; position:absolute; top:2px; left:4px;">${lastCleared.rank}</div><div style="font-size:14px;">${lastCleared.suit}</div>`;
                p.className = `pile has-cards ${lastCleared.color}`;
                p.style.boxShadow = `3px 3px 0 rgba(255,215,0,0.4)`;
            } else { p.className = 'pile'; p.innerHTML = ''; p.style.boxShadow = 'none'; }
        }

        init();
    </script>
</body>

</html>